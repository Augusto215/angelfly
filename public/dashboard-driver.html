<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AngelFly - Driver Dashboard</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="icon" type="image/x-icon" href="img/logo-angel (1) (1).ico" />

  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
  />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
@import url('https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Urbanist:ital,wght@0,100..900;1,100..900&display=swap');
  </style>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Montserrat' !important; }

    :root{
      --bg:#f3f1f0; --panel:#fff; --muted:#f0efef;
      --text:#111827; --primary:#ff7a18; --primary-dark:#ea580c;
      --sidebar-item:#fff; --sidebar-active:#e9e9e9;
      --radius-xl:14px; --radius-lg:10px;
    }

    body { background:radial-gradient(circle at top left, #ffe4c4 0, #f3f1f0 45%, #ffffff 100%); color:var(--text); }
    .app-shell{ min-height:100vh; display:flex; flex-direction:column; }

    .topbar{
      background:var(--panel); border-bottom:1px solid #e5e7eb;
      padding:20px 22px; display:flex; align-items:center; justify-content:space-between;
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .brand img{ height:7rem; object-fit:contain; }

    .topbar-right{ display:flex; align-items:center; gap:18px; font-size:14px; font-weight:500; }
    .topbar-user{ display:flex; align-items:center; gap:8px; }
    .logout-link{ cursor:pointer; color:var(--text); text-decoration:none; }
    .logout-link:hover{ text-decoration:underline; }

    .content-wrap{
      flex:1; width:100% !important; display:flex; justify-content:center;
      grid-template-columns:220px 1fr; gap:18px; padding:22px;
    }

    .sidebar{ background:transparent; padding-top:8px; width:30%; }
    .sidebar-card{ background:transparent; display:flex; flex-direction:column; gap:10px; }
    .sidebar-item{
      background:var(--sidebar-item); border-radius:8px; padding:12px 14px; font-size:14px;
      display:flex; align-items:center; justify-content:space-between; cursor:pointer; border:1px solid #eee;
    }
    .sidebar-item.active{ background:var(--sidebar-active); font-weight:600; }
    .sidebar-sub{ margin-left:10px; display:none; flex-direction:column; gap:8px; }
    .sidebar-sub .sidebar-item{ padding:10px 12px; font-size:13px; }
    .sidebar-item .left{ display:flex; align-items:center; gap:10px; }

    .debug-box{ display:none !important; }

    .main-panel{
      background:var(--panel); border-radius:var(--radius-xl);
      padding:25px 18px; width:100%; box-shadow:0 1px 0 rgba(0,0,0,0.03);
      display:flex; flex-direction:column; height:fit-content; gap:14px;
    }
    .panel-header{
      background:var(--muted); border-radius:10px; padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; font-size:15px; font-weight:600;
      gap:10px; flex-wrap:wrap;
    }
    .panel-header .muted{ font-weight:500; color:var(--text); }

    .table-card{
      background:var(--panel); border:1px solid #eee; border-radius:var(--radius-lg);
      padding:12px; position:relative;
    }
    .table-head{
      display:grid; grid-template-columns:120px 140px 1fr 140px;
      gap:1rem;
      font-size:13px; font-weight:700; padding:10px 12px;
    }
    .table-body{ max-height:340px; overflow-y:scroll; padding:6px 4px; }

    .row-item{
      display:grid;
      grid-template-columns:120px 140px 1fr 140px;
      align-items:center;
      padding:16px 12px;
      margin:6px 6px;
      border-radius:8px;
      background:#f0efef;
      font-size:14px;
      gap:1rem;
    }
    .row-item:nth-child(even){ background:#fff; }

    .row-item .value{
      text-align:right;
      font-weight:700;
    }

    .row-label{
      display:none;
      font-weight:600;
      margin-right:6px;
      opacity:0.7;
    }
    .row-value{
      display:inline-block;
    }

    .order-code{
      font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      background:#fff;
      border:1px solid #e5e7eb;
      cursor:help;
      max-width:100%;
      white-space:nowrap;
    }

    .panel-footer{
      display:flex; justify-content:flex-end; align-items:center; gap:12px; padding-top:10px;
      flex-wrap:wrap;
    }
    .week-select{
      background:var(--panel); border:1px solid #e5e7eb; border-radius:8px;
      padding:10px 12px; font-size:14px; min-width:200px;
    }

    .btn-generate{
      background:var(--primary); border:none; color:#fff; border-radius:8px; font-weight:700;
      padding:10px 18px; font-size:14px;
    }
    .btn-generate:hover{ background:var(--primary-dark); }

    /* loading overlay */
    .panel-loading{
      position:absolute; inset:0; background:rgba(255,255,255,0.7);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:10px; border-radius:var(--radius-lg); z-index:10;
    }
    .shimmer{
      width:96%; height:18px; border-radius:8px;
      background:linear-gradient(90deg,#eee 25%,#f7f7f7 50%,#eee 75%);
      background-size:200% 100%; animation:shimmer 1.1s infinite;
    }
    @keyframes shimmer{ 0%{background-position:200% 0} 100%{background-position:-200% 0} }

    .debug-box{
      margin-top:8px; background:#0b1020; color:#e5e7eb; font-size:12px;
      padding:10px; border-radius:8px; white-space:pre-wrap; display:none;
      max-height:160px; overflow:auto;
    }

    @media (max-width:900px){
      .content-wrap{ grid-template-columns:1fr; }
      .sidebar{ order:2; }
      .panel-header{ flex-direction:column; align-items:flex-start; gap:6px; }
      .table-head,
      .row-item{
        grid-template-columns:1fr 1fr;
      }
    }

    @media(max-width:768px){
      .table-card{ overflow:visible !important; }
      .table-body{ overflow-y:scroll !important; }

      .table-head{ display:none; }

      .row-item{
        grid-template-columns:1fr;
        align-items:flex-start;
        padding:12px 10px;
        font-size:13px;
        box-shadow:0 1px 3px rgba(0,0,0,0.05);
      }
      .row-item > div{
        display:flex;
        justify-content:space-between;
        width:100%;
      }
      .row-label{ display:inline-block; }
      .row-item .value{ text-align:right; }

      .customer{ display:flex !important; }

      .sidebar{ display:none !important; }
      .topbar .container{
        flex-direction:column !important;
        gap:10px !important;
      }
    }
  </style>
</head>

<body>
  <div class="app-shell">

    <header class="topbar">
      <div class="container d-flex justify-content-between align-items-center">
        <div class="brand">
          <img src="img/logo-angel.png" alt="AngelFly Logo" onerror="this.style.display='none'"/>
        </div>

        <div class="topbar-right">
          <div class="topbar-user">
            <i class="bi bi-person"></i>
            <span id="topUserName">Carregando...</span>
          </div>
          <a class="logout-link" onclick="handleLogout()">Log out</a>
        </div>
      </div>
    </header>

    <div class="content-wrap container">

      <aside class="sidebar">
        <div class="sidebar-card">
          <div class="sidebar-item active" onclick="setSection('dashboard')">
            <div class="left"><span>Driver Dashboard</span></div>
            <i class="bi bi-truck"></i>
          </div>

          <div class="sidebar-item d-none" onclick="toggleReports()">
            <div class=" left"><span>Reports</span></div>
            <i id="reportsChevron" class="bi bi-chevron-down"></i>
          </div>
          <div id="reportsSub" class="sidebar-sub">
            <div class="sidebar-item" onclick="setSection('reports-month')">
              <div class="left"><i class="bi bi-calendar3"></i><span>Monthly</span></div>
            </div>
            <div class="sidebar-item" onclick="setSection('reports-driver')">
              <div class="left"><i class="bi bi-truck"></i><span>Drivers</span></div>
            </div>
          </div>

          <div class="sidebar-item d-none" onclick="setSection('historic')">
            <div class="left "><span>Historic</span></div>
          </div>
        </div>
      </aside>

      <div class="d-flex flex-column align-items-end" style="width:100%;">
        <main class="main-panel">

          <div class="panel-header">
            <div>
              Driver: <span id="driverName" class="muted">Loading...</span>
            </div>
            <div>
              Total Earnings of <span id="weekLabel">--</span>:
              <span id="weekTotal">$0.00</span>
            </div>
          </div>

          <section class="table-card" id="tableCard">
            <div class="table-head" aria-hidden="true">
              <div>Order Code</div>
              <div>Day</div>
              <div class="customer">Customer</div>
              <div style="text-align:right;">Driver Total</div>
            </div>

            <div id="tableBody" class="table-body"></div>

            <div id="panelLoading" class="panel-loading" style="display:none;">
              <div class="spinner-border text-warning" role="status"></div>
              <div class="shimmer"></div>
              <div class="shimmer"></div>
              <div class="shimmer"></div>
              <small class="text-muted">Loading orders...</small>
            </div>
          </section>

          <div id="debugBox" class="debug-box"></div>

        </main>

        <div class="panel-footer">
          <select id="weekSelect" class="week-select" onchange="changeWeek()"></select>

          <button class="btn-generate" onclick="exportCSV()">Generate CSV</button>
          <button class="btn btn-outline-secondary" onclick="exportPDF()">Generate PDF</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // CONFIG
    // -----------------------------
    const REPORT_API_URL = "/api/report/month";
    const USER_CONTEXT_URL = "/api/user/context";
    const DEBUG = false; // set true to show debug box

    let USER_NAME = "Driver"; // <-- NOVO: VariÃ¡vel global para o nome do motorista
    let CURRENT_DRIVER_MATCH_ID = null;
    let CURRENT_ROWS = [];
    let CURRENT_WEEK_LABEL = "";
    let CURRENT_WEEK_START_DAY = 1; // default Monday

    // -----------------------------
    // DEBUG helpers
    // -----------------------------
    function logDebug(...args){
      if(!DEBUG) return;
      console.log("ðŸŸ§ [DRIVER]", ...args);
      const box = document.getElementById("debugBox");
      box.style.display = "block";
      box.textContent += args.map(a => {
        try { return typeof a === "string" ? a : JSON.stringify(a, null, 2); }
        catch(e){ return String(a); }
      }).join(" ") + "\n";
      box.scrollTop = box.scrollHeight;
    }

    // -----------------------------
    // HELPERS
    // -----------------------------
    function pad(n){ return String(n).padStart(2,"0"); }

    function formatISODate(dateObj){
      const y = dateObj.getFullYear();
      const m = pad(dateObj.getMonth()+1);
      const d = pad(dateObj.getDate());
      return `${y}-${m}-${d}`;
    }

    function formatDateBRShort(iso){
      if(!iso) return "--";
      const [y,m,d] = iso.split("-");
      return `${d}/${m}`;
    }

    function formatOrderCodeTrunc(code){
      if(!code) return "--";
      const s = String(code);
      return s.length <= 8 ? s : s.slice(0,8) + '...';
    }

    function safeGet(obj, path, fallback=null){
      try{ return path.split(".").reduce((o,k)=>o?.[k], obj) ?? fallback; }catch(e){ return fallback; }
    }

    // escape helper
    function escapeHtml(s){
      return String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
    }

    // truncate helper (default 10 chars)
    function truncateText(s, max = 10){
      if(s == null || s === "") return "--";
      const str = String(s);
      return str.length > max ? str.slice(0, max) + "..." : str;
    }

    // returns true if viewport is mobile (matches CSS breakpoint)
    function isMobileViewport(){
      return window.matchMedia && window.matchMedia('(max-width:768px)').matches;
    }

    // -----------------------------
    // WEEK SELECT (Mon-Sun anchor) - builds last 12 weeks
    // -----------------------------
    function weekAnchorFrom(date, weekStartDay = 1){
      const d = new Date(date);
      d.setHours(0,0,0,0);
      const dow = d.getDay(); // 0=Sunday
      let diff = dow - weekStartDay;
      if (diff < 0) diff += 7;
      const start = new Date(d);
      start.setDate(d.getDate() - diff);
      return start;
    }

    function buildWeekSelect(){
      const select = document.getElementById("weekSelect");
      select.innerHTML = "";

      const today = new Date();
      const anchor = weekAnchorFrom(today, CURRENT_WEEK_START_DAY); // semana comeÃ§a em CURRENT_WEEK_START_DAY

      const NUM_WEEKS = 12;
      for(let i=0;i<NUM_WEEKS;i++){
        const start = new Date(anchor);
        start.setDate(anchor.getDate() - i*7);
        const end = new Date(start);
        end.setDate(start.getDate() + 6);

        const startISO = formatISODate(start);
        const endISO = formatISODate(end);
        const label = `${formatDateBRShort(startISO)} â€” ${formatDateBRShort(endISO)}`;

        const opt = document.createElement("option");
        opt.value = `${startISO}|${endISO}`;
        opt.textContent = label;
        if(i===0) opt.selected = true;
        select.appendChild(opt);
      }
      logDebug("Week select built, first:", select.value);
    }

    // -----------------------------
    // INIT
    // -----------------------------
    document.addEventListener("DOMContentLoaded", async () => {
      await loadUserContext();
      buildWeekSelect();
      await generateReport(true);

      // re-render on resize so truncation toggles when switching between mobile/desktop
      window.addEventListener('resize', () => {
        renderTableRows(CURRENT_ROWS, CURRENT_WEEK_LABEL);
      });
    });

    // -----------------------------
    // LOAD USER CONTEXT (server provides driver fields)
    // -----------------------------
    async function loadUserContext(){
      try{
        logDebug("Fetching /api/user/context...");
        const res = await fetch(USER_CONTEXT_URL, { credentials: "include" });
        logDebug("Context status:", res.status);
        if(!res.ok) throw new Error("context fetch failed");
        const ctx = await res.json();
        logDebug("Context:", ctx);

        const displayName = safeGet(ctx, "driver.driver_name") || safeGet(ctx, "user.name") || safeGet(ctx, "user.email") || "Driver";
        CURRENT_DRIVER_MATCH_ID = safeGet(ctx, "driver.driver_match_id") || null;

        // if backend provided week_start_day for driver (or restaurant), use it
        const weekStartRaw = safeGet(ctx, "restaurant.week_start_day", null) ?? safeGet(ctx, "driver.week_start_day", null);
        if(Number.isInteger(weekStartRaw) && weekStartRaw >= 0 && weekStartRaw <= 6){
          CURRENT_WEEK_START_DAY = weekStartRaw;
        }

        document.getElementById("topUserName").textContent = displayName;
        document.getElementById("driverName").textContent = displayName;
        
        // NOVO: Captura o nome para o export
        USER_NAME = displayName; 

        logDebug("driver_match_id:", CURRENT_DRIVER_MATCH_ID, "week_start_day:", CURRENT_WEEK_START_DAY);
      }catch(e){
        console.error(e);
        logDebug("Context error:", e.message || e);
        document.getElementById("topUserName").textContent = "Erro ao carregar usuÃ¡rio";
        document.getElementById("driverName").textContent = "Erro";
      }
    }

    // -----------------------------
    // FETCH WEEKLY REPORT
    // -----------------------------
    async function generateReport(isAuto=false){
      const select = document.getElementById("weekSelect");
      if(!select || !select.value) { logDebug("No week selected"); return; }
      const [weekStart, weekEnd] = select.value.split("|");
      const weekLabel = select.options[select.selectedIndex].textContent;
      const month = weekStart.slice(0,7); // send YYYY-MM

      document.getElementById("weekLabel").textContent = weekLabel;
      logDebug("Generate report for", { weekStart, weekEnd, month });

      // show loading
      document.getElementById("panelLoading").style.display = "flex";

      try{
        const payload = { month, week_start: weekStart, week_end: weekEnd };

        const res = await fetch(REPORT_API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify(payload)
        });

        logDebug("Report status:", res.status);

        const text = await res.text();
        logDebug("Raw response text:", text.slice(0,1000));

        let data;
        try { data = JSON.parse(text); } catch(e){ throw new Error("Resposta invÃ¡lida do servidor"); }

        let rawList = [];
        if (Array.isArray(data)) rawList = data;
        else if (data?.items && Array.isArray(data.items)) rawList = data.items;
        else if (data?.object === "page") rawList = [data];
        else if (data?.json?.object === "page") rawList = [data.json];

        const pages = rawList.map(x => x?.json ?? x);
        logDebug("Items returned:", pages.length);

        const norm = pages.map(normalizeDriverOrder);

        // filter by createdISO in range [weekStart, weekEnd]
        const startD = new Date(weekStart);
        const endD = new Date(weekEnd);
        endD.setDate(endD.getDate() + 1); // exclusive upper bound

        const filtered = norm.filter(r => {
          if(!r.createdISO) return false;
          const d = new Date(r.createdISO);
          return d >= startD && d < endD;
        });

        filtered.sort((a,b) => (b.created_ts||0) - (a.created_ts||0));

        CURRENT_ROWS = filtered.map(o => ({ ...o, value: Number((o.value||0).toFixed(2)) }));
        CURRENT_WEEK_LABEL = weekLabel;

        renderTableRows(CURRENT_ROWS, weekLabel);
      }catch(e){
        console.error(e);
        logDebug("Weekly report error:", e.message || e);
        CURRENT_ROWS = [];
        renderTableRows([], weekLabel);
        if(!isAuto) alert("Erro ao carregar pedidos da semana.");
      }finally{
        document.getElementById("panelLoading").style.display = "none";
      }
    }

    function changeWeek(){ generateReport(false); }

    // -----------------------------
    // NORMALIZE DRIVER ORDER (same shape as restaurant)
    // -----------------------------
    function normalizeDriverOrder(page){
      const props = page.properties || {};

      const code =
        safeGet(props, 'Order Number: .title.0.plain_text') ||
        safeGet(props, 'Order Number: .title.0.text.content') ||
        page.id || page.order_code || "--";

      const customer =
        safeGet(props, 'Customer Name.rollup.array.0.title.0.plain_text') ||
        safeGet(props, 'Customer Name.rollup.array.0.title.0.text.content') ||
        safeGet(props, 'ðŸ‘¥ Custumer Name: .rich_text.0.plain_text') ||
        safeGet(page, 'customer') ||
        "--";

      const createdISO =
        safeGet(props, 'Order Placement DateTime.created_time') ||
        safeGet(props, 'Created time.created_time') ||
        page.created_time || null;

      const day = createdISO
        ? new Date(createdISO).toLocaleDateString("en-US", { month:"short", day:"numeric", year:"numeric" })
        : "--";

      // value candidates
      const valueCandidates = [
        "Driver Total Oficial:", "Driver Total Oficial", "Driver Total Paid Manual",
        "Driver Total","Formula Payment Driver","Driver Total Oficial"
      ];
      let value = null;
      for(const k of valueCandidates){
        const v = getNotionNumber(props, k);
        if(v != null){ value = v; break; }
      }
      if (value == null) value = page.driver_value || page.driver_total || page.value || 0;

      const created_ts = createdISO ? new Date(createdISO).getTime() : (page.created_ts || 0);

      return { code, customer, createdISO, day, value: Number(value||0), created_ts };
    }

    function getNotionNumber(props, key){
      try{
        const p = props?.[key];
        if(!p) return null;
        if(p.type === "number") return p.number ?? null;
        if(p.type === "formula") return p.formula?.number ?? null;
        if(p.type === "rollup"){
          const arr = p.rollup?.array;
          if(Array.isArray(arr) && arr[0]){
            const first = arr[0];
            if(first.type === "number") return first.number ?? null;
            if(first.type === "formula") return first.formula?.number ?? null;
          }
        }
        return null;
      }catch(e){ return null; }
    }

    // -----------------------------
    // RENDER TABLE ROWS (truncates customer only on mobile)
    // -----------------------------
    function renderTableRows(rows, weekLabel){
      const body = document.getElementById("tableBody");
      document.getElementById("weekLabel").textContent = weekLabel || "--";

      if(!rows || rows.length === 0){
        body.innerHTML = `
          <div class="p-3 text-muted" style="font-size:14px;">
            No order found for this week.
          </div>
        `;
        document.getElementById("weekTotal").textContent = `$0.00`;
        return;
      }

      const mobile = isMobileViewport();

      body.innerHTML = rows.map(r => {
        const fullCustomer = r.customer || "--";
        const displayCustomer = mobile ? truncateText(fullCustomer, 10) : fullCustomer;

        return `
          <div class="row-item" title="${escapeHtml(r.code)}">
            <div>
              <span class="row-label">Order:</span>
              <span class="row-value order-code">${escapeHtml(formatOrderCodeTrunc(r.code))}</span>
            </div>
            <div>
              <span class="row-label">Day:</span>
              <span class="row-value">${escapeHtml(r.day)}</span>
            </div>
            <div class="customer">
              <span class="row-label">Customer:</span>
              <span class="row-value" title="${escapeHtml(fullCustomer)}">${escapeHtml(displayCustomer)}</span>
            </div>
            <div class="value">
              <span class="row-label">Value:</span>
              <span class="row-value">$${Number(r.value||0).toFixed(2)}</span>
            </div>
          </div>
        `;
      }).join("");

      const total = rows.reduce((acc, r) => acc + (Number(r.value)||0), 0);
      document.getElementById("weekTotal").textContent = `$${total.toFixed(2)}`;
    }

    // -----------------------------
    // EXPORT CSV
    // -----------------------------
    function csvEscape(val){
      const s = String(val ?? "");
      if(/[",\n;]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    }

    function exportCSV(){
      if(!CURRENT_ROWS || !CURRENT_ROWS.length){
        alert("NÃ£o hÃ¡ pedidos nesta semana para exportar.");
        return;
      }
      const header = ["Order Code","Day","Customer","Driver Total"];
      const lines = [
        header.join(","),
        ...CURRENT_ROWS.map(r => [
          csvEscape(r.code),
          csvEscape(r.day),
          csvEscape(r.customer),
          csvEscape(Number(r.value).toFixed(2))
        ].join(","))
      ];
      const csvContent = "\uFEFF" + lines.join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      
      const labelSafe = (document.getElementById("weekLabel").textContent || "week").replace(/\s+/g,"_").replace(/[^\w\-]/g,"");
      
      // NOVO: Adiciona o nome do motorista ao nome do arquivo
      const fileSafeName = (USER_NAME || "driver")
          .replace(/\s+/g, "_")
          .replace(/[^ \w\-]/g, "");

      const a = document.createElement("a");
      a.href = url;
      a.download = `angelFly_driver_${fileSafeName}_${labelSafe}.csv`; // <-- MODIFICADO
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    // -----------------------------
    // EXPORT PDF
    // -----------------------------
    function exportPDF(){
      if(!CURRENT_ROWS || !CURRENT_ROWS.length){
        alert("NÃ£o hÃ¡ pedidos nesta semana para exportar.");
        return;
      }
      if(!window.jspdf || !window.jspdf.jsPDF){
        alert("Biblioteca de PDF nÃ£o carregou. Recarregue a pÃ¡gina.");
        return;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'a4' });
      const title = "AngelFly - Driver Weekly Report";
      const driverName = document.getElementById("driverName")?.textContent || "Driver";
      const weekLabel = document.getElementById("weekLabel")?.textContent || "";
      const total = CURRENT_ROWS.reduce((acc, r) => acc + (Number(r.value)||0), 0).toFixed(2);

      let y = 40;
      doc.setFontSize(14); doc.text(title, 40, y); y += 18;
      doc.setFontSize(11); doc.text(`Driver: ${driverName}`, 40, y); y += 14;
      doc.text(`Week: ${weekLabel}`, 40, y); y += 18;

      const fontSize = 10; const lineHeight = 12;
      doc.setFontSize(fontSize);
      doc.text("Order", 40, y); doc.text("Day", 190, y); doc.text("Customer", 290, y); doc.text("Value", 520, y, { align: "right" });
      y += 6; doc.line(36, y, 560, y); y += 10;

      const pageHeight = doc.internal.pageSize.height || doc.internal.pageSize.getHeight();

      CURRENT_ROWS.forEach((r) => {
        const fullCode = String(r.code || "");
        const customerText = String(r.customer || "--");
        const codeLines = doc.splitTextToSize(fullCode, 120);
        const custLines = doc.splitTextToSize(customerText, 200);
        const maxLines = Math.max(codeLines.length, custLines.length, 1);
        const needed = maxLines * lineHeight + 6;

        if (y + needed > pageHeight - 60) {
          doc.addPage();
          y = 40;
          doc.setFontSize(fontSize);
          doc.text("Order", 40, y); doc.text("Day", 190, y); doc.text("Customer", 290, y); doc.text("Value", 520, y, { align: "right" });
          y += 6; doc.line(36, y, 560, y); y += 10;
        }

        for(let i=0;i<maxLines;i++){
          const lineY = y + i * lineHeight;
          if(codeLines[i]) doc.text(codeLines[i], 40, lineY);
          if(i === 0) doc.text(r.day || "--", 190, lineY);
          if(custLines[i]) doc.text(custLines[i], 290, lineY);
          if(i === 0) doc.text(`$${Number(r.value||0).toFixed(2)}`, 520, lineY, { align: "right" });
        }
        y += maxLines * lineHeight + 6;
      });

      if(y > pageHeight - 60){ doc.addPage(); y = 40; }
      y += 8;
      doc.setFontSize(12);
      doc.text(`TOTAL: $${total}`, 520, y, { align: "right" });

      const labelSafe = (document.getElementById("weekLabel").textContent || "week").replace(/\s+/g,"_").replace(/[^\w\-]/g,"");
      
      // NOVO: Adiciona o nome do motorista ao nome do arquivo
      const fileSafeName = (USER_NAME || "driver")
          .replace(/\s+/g, "_")
          .replace(/[^ \w\-]/g, "");

      doc.save(`angelFly_driver_${fileSafeName}_${labelSafe}.pdf`); // <-- MODIFICADO
    }

    // -----------------------------
    // SIDEBAR helpers & LOGOUT
    // -----------------------------
    function toggleReports(){
      const sub = document.getElementById("reportsSub");
      const chev = document.getElementById("reportsChevron");
      const open = sub.style.display === "flex";
      sub.style.display = open ? "none" : "flex";
      chev.className = open ? "bi bi-chevron-down" : "bi bi-chevron-up";
    }

    function setSection(section){
      document.querySelectorAll(".sidebar-item").forEach(el => el.classList.remove("active"));
      const items = document.querySelectorAll(".sidebar-card > .sidebar-item");
      if(section === "dashboard") items[0].classList.add("active");
      if(section.startsWith("reports")) items[1].classList.add("active");
      if(section === "historic") items[2].classList.add("active");
    }

    async function handleLogout(){
      try{
        await fetch("/api/logout", { method:"POST", credentials:"include" });
        window.location.href = "/login-driver.html";
      }catch(e){
        window.location.href = "/login-driver.html";
      }
    }
  </script>
</body>
</html>