<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AngelFly - Create User</title>

  <!-- Bootstrap 5 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- Bootstrap Icons -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
  />
  <style>
@import url('https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Urbanist:ital,wght@0,100..900;1,100..900&display=swap');
  </style>

  <style>
    * {
      margin:0;
      padding:0;
      box-sizing:border-box;
      font-family:'Montserrat', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
    }

    :root{
      --bg:#f3f1f0;
      --bg-gradient: radial-gradient(circle at top left, #ffe4c4 0, #f3f1f0 45%, #ffffff 100%);
      --panel:#fff;
      --muted:#f6f6f6;
      --text:#111827;
      --primary:#ff7a18;
      --primary-dark:#ea580c;
      --primary-soft:rgba(255,122,24,0.12);
      --sidebar-item:#fff;
      --sidebar-active:#111827;
      --sidebar-active-text:#ffffff;
      --radius-xl:18px;
      --radius-lg:12px;
      --shadow-soft:0 18px 45px rgba(15,23,42,0.12);
    }

    body {
      background:var(--bg-gradient);
      color:var(--text);
    }

    .app-shell{
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    .topbar{
      background:transparent;
      padding:18px 22px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    .topbar-inner{
      background:rgba(255,255,255,0.92);
      backdrop-filter: blur(14px);
      border-radius:999px;
      padding:10px 18px;
      border:1px solid rgba(148,163,184,0.25);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      width:100%;
      max-width:1180px;
      margin:0 auto;
      box-shadow:0 10px 30px rgba(15,23,42,0.08);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .brand img{
      height:3.5rem;
      object-fit:contain;
    }

    .brand-title{
      font-size:14px;
      font-weight:600;
      letter-spacing:0.03em;
      text-transform:uppercase;
      color:#6b7280;
    }

    .topbar-right{
      display:flex;
      align-items:center;
      gap:14px;
      font-size:14px;
      font-weight:500;
    }

    .topbar-user-pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 12px;
      border-radius:999px;
      background:var(--muted);
      font-size:13px;
    }

    .topbar-user-pill i{
      font-size:16px;
    }

    .logout-link{
      cursor:pointer;
      color:var(--primary-dark);
      text-decoration:none;
      font-size:13px;
      font-weight:600;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(249,115,22,0.3);
      background:rgba(249,115,22,0.06);
    }

    .logout-link:hover{
      background:rgba(249,115,22,0.12);
    }

    .content-wrap{
      flex:1;
      width:100% !important;
      display:flex;
      justify-content:center;
      padding:18px 16px 32px;
    }

    .content-inner{
      display:grid;
      grid-template-columns:260px minmax(0,1fr);
      gap:20px;
      width:100%;
      max-width:1180px;
      align-items:flex-start;
    }

    /* SIDEBAR */
    .sidebar{
      background:transparent;
    }

    .sidebar-card{
      background:rgba(255,255,255,0.9);
      backdrop-filter: blur(18px);
      border-radius:var(--radius-xl);
      padding:14px 12px;
      border:1px solid rgba(148,163,184,0.25);
      box-shadow:0 12px 35px rgba(15,23,42,0.08);
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .sidebar-title{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      font-weight:600;
      color:#9ca3af;
      padding:4px 10px 2px;
    }

    .sidebar-item{
      background:var(--sidebar-item);
      border-radius:999px;
      padding:9px 12px;
      font-size:13px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      cursor:pointer;
      border:1px solid transparent;
      transition:all 0.16s ease-out;
    }

    .sidebar-item .left{
      display:flex;
      align-items:center;
      gap:9px;
    }

    .sidebar-item i{
      opacity:0.8;
      font-size:15px;
    }

    .sidebar-item:hover{
      border-color:rgba(148,163,184,0.5);
      background:rgba(255,255,255,0.95);
    }

    .sidebar-item.active{
      background:var(--sidebar-active);
      color:var(--sidebar-active-text);
      border-color:var(--sidebar-active);
      box-shadow:0 10px 26px rgba(15,23,42,0.35);
    }

    .sidebar-item.active i{
      opacity:1;
    }

    /* MAIN PANEL */
    .main-panel-wrapper{
      width:100%;
      display:flex;
      justify-content:flex-end;
    }

    .main-panel{
      background:var(--panel);
      border-radius:var(--radius-xl);
      padding:24px 22px 22px;
      width:100%;
      max-width:820px;
      box-shadow:var(--shadow-soft);
      border:1px solid rgba(148,163,184,0.16);
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .panel-header{
      border-radius:18px;
      padding:16px 16px 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      font-size:15px;
      font-weight:600;
      flex-wrap:wrap;
      gap:10px;
      background:
        radial-gradient(circle at top left, rgba(255,122,24,0.16), transparent 55%),
        var(--muted);
    }

    .panel-header-main{
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .panel-title-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 9px;
      border-radius:999px;
      background:var(--primary-soft);
      color:var(--primary-dark);
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      font-weight:600;
    }

    .panel-title{
      font-size:18px;
      font-weight:700;
    }

    .panel-header .muted{
      font-weight:500;
      color:#4b5563;
      font-size:13px;
      max-width:380px;
    }

    .panel-meta-chip{
      padding:6px 10px;
      border-radius:999px;
      background:#fff;
      border:1px dashed rgba(148,163,184,0.6);
      font-size:12px;
      color:#6b7280;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .panel-meta-dot{
      width:7px;
      height:7px;
      border-radius:999px;
      background:#22c55e;
    }

    /* FORM */
    .form-section{
      border-radius:16px;
      border:1px solid rgba(209,213,219,0.8);
      padding:16px 14px 8px;
      background:#ffffff;
    }

    .form-section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
      gap:8px;
    }

    .form-section-title span{
      font-size:13px;
      font-weight:600;
      color:#4b5563;
    }

    .form-section-sub{
      font-size:12px;
      color:#9ca3af;
    }

    .form-label{
      font-size:13px;
      font-weight:500;
      color:#374151;
      margin-bottom:4px;
    }

    .form-control,
    .form-select{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.75);
      font-size:13px;
      padding:9px 12px;
      min-height:40px;
      background:#f9fafb;
      transition:all 0.14s ease-out;
    }

    .form-control:focus,
    .form-select:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 1px rgba(249,115,22,0.28);
      background:#ffffff;
    }

    .form-text{
      font-size:11px;
      color:#9ca3af;
    }

    .role-pill-group{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }

    .role-pill-group select{
      max-width:210px;
    }

    .checkbox-chip{
      display:flex;
      align-items:center;
      gap:6px;
      padding:7px 10px;
      border-radius:999px;
      background:#f9fafb;
      border:1px solid rgba(209,213,219,0.9);
      font-size:12px;
      color:#4b5563;
      margin-top:8px;
    }

    .checkbox-chip .form-check-input{
      margin-top:0;
    }

    .btn-generate{
      background:var(--primary);
      border:none;
      color:#fff;
      border-radius:999px;
      font-weight:700;
      padding:9px 18px;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .btn-generate:hover{
      background:var(--primary-dark);
    }

    .btn-outline-secondary{
      border-radius:999px;
      font-size:13px;
      padding-inline:16px;
    }

    .alert{
      border-radius:14px;
      font-size:13px;
      padding:9px 12px;
    }

    @media (max-width:992px){
      .content-inner{
        grid-template-columns:1fr;
      }
      .sidebar{
        order:2;
      }
      .main-panel-wrapper{
        order:1;
        justify-content:center;
      }
      .main-panel{
        max-width:100%;
      }
    }

    @media(max-width:768px){
      .topbar{
        padding: 0 !important; 
        border-radius: 0 !important;
        padding-inline:0 !important;
      }
      .topbar-inner
      {        border-radius: 0 !important;

        flex-direction: column !important;
      }

      .topbar-inner{
        padding-inline:0 !important;
      }

      .content-wrap{
        padding-inline:12px;
      }

      .sidebar{
        display:none;
      }

      .main-panel{
        padding:20px 16px 18px;
      }

      .panel-header{
        padding:14px 12px 12px;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- TOPBAR -->
    <header class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <img src="img/logo-angel.png" alt="AngelFly Logo" onerror="this.style.display='none'"/>
          <div>
            <div class="brand-title">AngelFly Admin</div>
            <div style="font-size:12px; color:#6b7280;">User management panel</div>
          </div>
        </div>

        <div class="topbar-right">
          <div class="topbar-user-pill">
            <i class="bi bi-person"></i>
            <span id="topUserName">Loading...</span>
          </div>
          <a class="logout-link" onclick="handleLogout()">Log out</a>
        </div>
      </div>
    </header>

    <!-- CONTENT -->
    <div class="content-wrap">
      <div class="content-inner">
        <!-- SIDEBAR -->
        <aside class="sidebar">
          <div class="sidebar-card">
            <div class="sidebar-title">Admin</div>

            <div class="sidebar-item" onclick="navigateDashboard()">
              <div class="left">
                <i class="bi bi-grid"></i>
                <span>Dashboard</span>
              </div>
              <i class="bi bi-chevron-right"></i>
            </div>

            <div class="sidebar-item active">
              <div class="left">
                <i class="bi bi-person-plus"></i>
                <span>Create Users</span>
              </div>
              <span style="font-size:10px; text-transform:uppercase; letter-spacing:0.08em;">Now</span>
            </div>
          </div>
        </aside>

        <!-- MAIN PANEL -->
        <div class="main-panel-wrapper">
          <main class="main-panel">
            <div class="panel-header">
              <div class="panel-header-main">
                <div class="panel-title-badge">
                  <i class="bi bi-shield-lock"></i> Admin only
                </div>
                <div class="panel-title">Create new user</div>
              </div>
              <div class="muted">
                Fill in the fields below to create a new user in AngelFly. You can set the access level and, if needed, adjust the restaurant week configuration.
              </div>
              <div class="panel-meta-chip">
                <span class="panel-meta-dot"></span>
                <span>Real-time access control</span>
              </div>
            </div>

            <form id="userForm" class="mt-2">
              <!-- SECTION: Basic info -->
              <div class="form-section mb-3">
                <div class="form-section-title">
                  <span>Basic information</span>
                  <span class="form-section-sub">Email, password and full name.</span>
                </div>

                <div class="row g-3">
                  <!-- EMAIL -->
                  <div class="col-md-6">
                    <label for="email" class="form-label">Email *</label>
                    <input type="email" class="form-control" id="email" required />
                  </div>

                  <!-- PASSWORD -->
                  <div class="col-md-6">
                    <label for="password" class="form-label">
                      Password (optional)
                    </label>
                    <input
                      type="password"
                      class="form-control"
                      id="password"
                      placeholder="Leave blank to auto-generate"
                    />
                  </div>

                  <!-- FULL NAME -->
                  <div class="col-md-8">
                    <label for="full_name" class="form-label">Full name *</label>
                    <input type="text" class="form-control" id="full_name" required />
                  </div>

                  <!-- ROLE -->
                  <div class="col-md-4">
                    <label for="user_role" class="form-label">Role *</label>
                    <div class="role-pill-group">
                      <select id="user_role" class="form-select" required>
                        <option value="">Select...</option>
                        <option value="restaurant">Restaurant</option>
                        <option value="driver">Driver</option>
                        <option value="admin">Admin</option>
                      </select>
                    </div>
                    <div class="form-text">
                      Choose whether the user is a restaurant, driver or admin.
                    </div>
                  </div>
                </div>
              </div>

              <!-- SECTION: Match & week -->
              <div class="form-section mb-3">
                <div class="form-section-title">
                  <span>Match & Restaurant week</span>
                  <span class="form-section-sub">
                    Link the user to Notion/system and, if it's a restaurant, set the week start/end.
                  </span>
                </div>

                <div class="row g-3">
                  <!-- MATCH ID -->
                  <div class="col-md-6">
                    <label for="match_id" class="form-label">
                      Match ID (Notion / Restaurant / Driver)
                    </label>
                    <input type="text" class="form-control" id="match_id" />
                    <div class="form-text">
                      ID used to match with Notion or other systems (e.g. <code>230e8d38-9ad5-80...</code>).
                    </div>
                  </div>

                  <!-- WEEK START / END (RESTAURANT ONLY) -->
                  <div class="col-md-6" id="weekConfigWrapper" style="display:none;">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label for="week_start_day" class="form-label">
                          Week start (restaurant)
                        </label>
                        <select id="week_start_day" class="form-select">
                          <option value="">Default</option>
                          <option value="0">Sunday</option>
                          <option value="1">Monday</option>
                          <option value="2">Tuesday</option>
                          <option value="3">Wednesday</option>
                          <option value="4">Thursday</option>
                          <option value="5">Friday</option>
                          <option value="6">Saturday</option>
                        </select>
                      </div>

                      <div class="col-md-6">
                        <label for="week_end_day" class="form-label">
                          Week end (restaurant)
                        </label>
                        <select id="week_end_day" class="form-select">
                          <option value="">Default</option>
                          <option value="0">Sunday</option>
                          <option value="1">Monday</option>
                          <option value="2">Tuesday</option>
                          <option value="3">Wednesday</option>
                          <option value="4">Thursday</option>
                          <option value="5">Friday</option>
                          <option value="6">Saturday</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <!-- IS ACTIVE -->
                  <div class="col-md-4">
                    <div class="checkbox-chip">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="is_active"
                        checked
                      />
                      <label class="form-check-label" for="is_active">
                        Active user
                      </label>
                    </div>
                  </div>
                </div>
              </div>

              <div class="d-flex justify-content-end gap-2 mt-3">
                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  onclick="document.getElementById('userForm').reset(); toggleWeekFields();"
                >
                  Clear
                </button>

                <button type="submit" class="btn-generate" id="btnSubmit">
                  <span id="btnSubmitText">Create user</span>
                  <span
                    id="btnSubmitSpinner"
                    class="spinner-border spinner-border-sm"
                    role="status"
                    style="display:none;"
                  ></span>
                </button>
              </div>
            </form>

            <div id="feedback" class="alert mt-3" style="display:none;"></div>
          </main>
        </div>
      </div>
    </div>
  </div>

  <script>
    const CREATE_USER_API_URL = "/api/admin/users";

    function safeGet(obj, path, fallback=null){
      try{
        return path.split(".").reduce((o, k)=>o?.[k], obj) ?? fallback;
      }catch(e){ return fallback; }
    }

    document.addEventListener("DOMContentLoaded", () => {
      initPage();
    });

    async function initPage(){
      await loadUserContext();
      setupForm();
    }

    async function loadUserContext(){
      try{
        const res = await fetch("/api/user/context", { credentials:"include" });
        if(!res.ok) throw new Error("context fetch failed");
        const ctx = await res.json();

        const displayName =
          safeGet(ctx, "restaurant.restaurant_name") ||
          safeGet(ctx, "user.name") ||
          safeGet(ctx, "user.email") ||
          "User";

        document.getElementById("topUserName").textContent = displayName;
      }catch(e){
        document.getElementById("topUserName").textContent = "Failed to load user";
      }
    }

    function setupForm(){
      const form = document.getElementById("userForm");
      form.addEventListener("submit", handleCreateUser);

      const roleSelect = document.getElementById("user_role");
      roleSelect.addEventListener("change", toggleWeekFields);
    }

    function toggleWeekFields(){
      const role = document.getElementById("user_role").value;
      const wrapper = document.getElementById("weekConfigWrapper");
      const weekStart = document.getElementById("week_start_day");
      const weekEnd = document.getElementById("week_end_day");

      if (role === "restaurant") {
        wrapper.style.display = "block";
      } else {
        wrapper.style.display = "none";
        weekStart.value = "";
        weekEnd.value = "";
      }
    }

    function setLoading(isLoading){
      const btn = document.getElementById("btnSubmit");
      const text = document.getElementById("btnSubmitText");
      const spinner = document.getElementById("btnSubmitSpinner");

      if(isLoading){
        btn.disabled = true;
        text.textContent = "Creating...";
        spinner.style.display = "inline-block";
      } else {
        btn.disabled = false;
        text.textContent = "Create user";
        spinner.style.display = "none";
      }
    }

    function showFeedback(type, message){
      const fb = document.getElementById("feedback");
      fb.style.display = message ? "block" : "none";
      fb.className = "alert mt-3 alert-" + (type === "error" ? "danger" : "success");
      fb.textContent = message || "";
    }

    async function handleCreateUser(event){
      event.preventDefault();
      setLoading(true);
      showFeedback("success", ""); // clear

      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      const user_role = document.getElementById("user_role").value;
      const full_name = document.getElementById("full_name").value.trim();
      const match_id = document.getElementById("match_id").value.trim();
      const week_start_day_raw = document.getElementById("week_start_day").value;
      const week_end_day_raw = document.getElementById("week_end_day").value;
      const is_active = document.getElementById("is_active").checked;

      if(!email || !user_role || !full_name){
        showFeedback("error", "Please fill at least Email, Role and Full name.");
        setLoading(false);
        return;
      }

      let week_start_day = null;
      let week_end_day = null;
      if (user_role === "restaurant") {
        week_start_day = week_start_day_raw !== "" ? Number(week_start_day_raw) : null;
        week_end_day = week_end_day_raw !== "" ? Number(week_end_day_raw) : null;
      }

      const payload = {
        email,
        user_role,
        full_name,
        match_id: match_id || null,
        week_start_day,
        week_end_day,
        is_active
      };

      if (password && password.trim().length >= 6) {
        payload.password = password.trim();
      }

      try{
        const res = await fetch(CREATE_USER_API_URL, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          credentials:"include",
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        let data;
        try { data = JSON.parse(text); }
        catch(e){ data = { message: text }; }

        if(!res.ok){
          const msg = data?.message || data?.error || "Failed to create user.";
          showFeedback("error", msg);
        } else {
          const tempPass = data?.user?.password;
          let successMsg = "User created successfully.";
          if (tempPass) {
            successMsg += ` Password: ${tempPass}`;
          }
          showFeedback("success", successMsg);
          document.getElementById("password").value = "";
        }

      }catch(e){
        showFeedback("error", "Communication error with the server.");
      }finally{
        setLoading(false);
      }
    }

    function navigateDashboard(){
      window.location.href = "/admin";
    }

    async function handleLogout(){
      try{
        await fetch("/api/logout", { method:"POST", credentials:"include" });
        window.location.href = "/login-restaurant.html";
      }catch(e){
        window.location.href = "/login-restaurant.html";
      }
    }
  </script>
</body>
</html>
