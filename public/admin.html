<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AngelFly - Admin Panel</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
  />
  <style>
@import url('https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Urbanist:ital,wght@0,100..900;1,100..900&display=swap');
  </style>

  <style>
    /* * CSS DE ESTILIZAÇÃO GERAL (Mantido do código anterior) */
    * {
      margin:0;
      padding:0;
      box-sizing:border-box;
      font-family:'Montserrat', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
    }

    :root{
      --bg:#f3f1f0;
      --bg-gradient: radial-gradient(circle at top left, #ffe4c4 0, #f3f1f0 45%, #ffffff 100%);
      --panel:#fff;
      --muted:#f6f6f6;
      --text:#111827;
      --primary:#ff7a18;
      --primary-dark:#ea580c;
      --primary-soft:rgba(255,122,24,0.12);
      --sidebar-item:#fff;
      --sidebar-active:#111827;
      --sidebar-active-text:#ffffff;
      --radius-xl:18px;
      --radius-lg:12px;
      --shadow-soft:0 18px 45px rgba(15,23,42,0.12);
    }

    body {
      background:var(--bg-gradient);
      color:var(--text);
    }

    .app-shell{
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    .topbar{
      background:transparent;
      padding:18px 22px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    .topbar-inner{
      background:rgba(255,255,255,0.92);
      backdrop-filter: blur(14px);
      border-radius:999px;
      padding:10px 18px;
      border:1px solid rgba(148,163,184,0.25);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      width:100%;
      max-width:1180px;
      margin:0 auto;
      box-shadow:0 10px 30px rgba(15,23,42,0.08);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .brand img{
      height:3.5rem;
      object-fit:contain;
    }

    .brand-title{
      font-size:14px;
      font-weight:600;
      letter-spacing:0.03em;
      text-transform:uppercase;
      color:#6b7280;
    }

    .topbar-right{
      display:flex;
      align-items:center;
      gap:14px;
      font-size:14px;
      font-weight:500;
    }

    .topbar-user-pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 12px;
      border-radius:999px;
      background:var(--muted);
      font-size:13px;
    }

    .topbar-user-pill i{
      font-size:16px;
    }

    .logout-link{
      cursor:pointer;
      color:var(--primary-dark);
      text-decoration:none;
      font-size:13px;
      font-weight:600;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(249,115,22,0.3);
      background:rgba(249,115,22,0.06);
    }

    .logout-link:hover{
      background:rgba(249,115,22,0.12);
    }

    .content-wrap{
      flex:1;
      width:100% !important;
      display:flex;
      justify-content:center;
      padding:18px 16px 32px;
    }

    .content-inner{
      display:grid;
      grid-template-columns:260px minmax(0,1fr);
      gap:20px;
      width:100%;
      max-width:1180px;
      align-items:flex-start;
    }

    /* SIDEBAR */
    .sidebar{
      background:transparent;
    }

    .sidebar-card{
      background:rgba(255,255,255,0.9);
      backdrop-filter: blur(18px);
      border-radius:var(--radius-xl);
      padding:14px 12px;
      border:1px solid rgba(148,163,184,0.25);
      box-shadow:0 12px 35px rgba(15,23,42,0.08);
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .sidebar-title{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      font-weight:600;
      color:#9ca3af;
      padding:4px 10px 2px;
    }

    .sidebar-item{
      background:var(--sidebar-item);
      border-radius:999px;
      padding:9px 12px;
      font-size:13px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      cursor:pointer;
      border:1px solid transparent;
      transition:all 0.16s ease-out;
    }

    .sidebar-item .left{
      display:flex;
      align-items:center;
      gap:9px;
    }

    .sidebar-item i{
      opacity:0.8;
      font-size:15px;
    }

    .sidebar-item:hover{
      border-color:rgba(148,163,184,0.5);
      background:rgba(255,255,255,0.95);
    }

    .sidebar-item.active{
      background:var(--sidebar-active);
      color:var(--sidebar-active-text);
      border-color:var(--sidebar-active);
      box-shadow:0 10px 26px rgba(15,23,42,0.35);
    }

    .sidebar-item.active i{
      opacity:1;
    }

    /* MAIN PANEL */
    .main-panel-wrapper{
      width:100%;
      display:flex;
      justify-content:flex-end;
    }

    .main-panel{
      background:var(--panel);
      border-radius:var(--radius-xl);
      padding:24px 22px 22px;
      width:100%;
      max-width:820px;
      box-shadow:var(--shadow-soft);
      border:1px solid rgba(148,163,184,0.16);
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .panel-header{
      border-radius:18px;
      padding:16px 16px 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      font-size:15px;
      font-weight:600;
      flex-wrap:wrap;
      gap:10px;
      background:
        radial-gradient(circle at top left, rgba(255,122,24,0.16), transparent 55%),
        var(--muted);
    }

    .panel-header-main{
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .panel-title-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 9px;
      border-radius:999px;
      background:var(--primary-soft);
      color:var(--primary-dark);
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      font-weight:600;
    }

    .panel-title{
      font-size:18px;
      font-weight:700;
    }

    .panel-header .muted{
      font-weight:500;
      color:#4b5563;
      font-size:13px;
      max-width:380px;
    }

    .panel-meta-chip{
      padding:6px 10px;
      border-radius:999px;
      background:#fff;
      border:1px dashed rgba(148,163,184,0.6);
      font-size:12px;
      color:#6b7280;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .panel-meta-dot{
      width:7px;
      height:7px;
      border-radius:999px;
      background:#22c55e;
    }

    /* FORM / TABLE */
    .form-section{
      border-radius:16px;
      border:1px solid rgba(209,213,219,0.8);
      padding:16px 14px 8px;
      background:#ffffff;
    }

    .form-section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
      gap:8px;
    }

    .form-section-title span{
      font-size:13px;
      font-weight:600;
      color:#4b5563;
    }

    .form-section-sub{
      font-size:12px;
      color:#9ca3af;
    }

    .form-label{
      font-size:13px;
      font-weight:500;
      color:#374151;
      margin-bottom:4px;
    }

    .form-control,
    .form-select{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.75);
      font-size:13px;
      padding:9px 12px;
      min-height:40px;
      background:#f9fafb;
      transition:all 0.14s ease-out;
    }

    .form-control:focus,
    .form-select:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 1px rgba(249,115,22,0.28);
      background:#ffffff;
    }

    .form-text{
      font-size:11px;
      color:#9ca3af;
    }

    .role-pill-group{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }

    .role-pill-group select{
      max-width:210px;
    }

    .checkbox-chip{
      display:flex;
      align-items:center;
      gap:6px;
      padding:7px 10px;
      border-radius:999px;
      background:#f9fafb;
      border:1px solid rgba(209,213,219,0.9);
      font-size:12px;
      color:#4b5563;
      margin-top:8px;
    }

    .checkbox-chip .form-check-input{
      margin-top:0;
    }

    .btn-generate,
    .btn-primary{
      background:var(--primary);
      border:none;
      color:#fff;
      border-radius:999px;
      font-weight:700;
      padding:9px 18px;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .btn-generate:hover,
    .btn-primary:hover{
      background:var(--primary-dark);
    }

    .btn-outline-secondary{
      border-radius:999px;
      font-size:13px;
      padding-inline:16px;
    }

    .alert{
      border-radius:14px;
      font-size:13px;
      padding:9px 12px;
    }

    .table{
      font-size:13px;
      margin-bottom:0;
    }

    .table thead th{
      border-bottom-width:1px;
      font-weight:600;
      color:#4b5563;
      padding:10px 12px;
    }

    .table tbody td{
      vertical-align:middle;
      padding:10px 12px;
    }

    .table-responsive{
      border-radius:16px;
      border:1px solid rgba(209,213,219,0.8);
      overflow-x:auto;
    }

    .badge-role{
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .role-restaurant{ background: rgba(249,115,22,0.15); color: #ea580c; }
    .role-driver{ background: rgba(34,197,94,0.15); color: #16a34a; }
    .role-admin{ background: rgba(59,130,246,0.15); color: #2563eb; }
    
    .status-active{ color: #16a34a; }
    .status-inactive{ color: #ef4444; }

    .btn-action{
        padding: 4px 8px;
        font-size: 13px;
        margin-right: 4px;
        cursor: pointer;
    }

    .btn-action i{
        font-size: 16px;
    }

    .modal-content{
        border-radius: 18px;
    }

    .modal-header{
        border-bottom: none;
        padding-bottom: 0;
    }

    .modal-footer{
        border-top: none;
        padding-top: 0;
    }

    /* RESPONSIVIDADE GERAL */
    @media (max-width:992px){
      .content-inner{
        grid-template-columns:1fr;
      }
      .sidebar{
        order:2;
      }
      .main-panel-wrapper{
        order:1;
        justify-content:center;
      }
      .main-panel{
        max-width:100%;
      }
    }

    @media(max-width:768px){
      .topbar{
        padding: 0 !important; 
        border-radius: 0 !important;
        padding-inline:0 !important;
      }
      .topbar-inner
      {        border-radius: 0 !important;

        flex-direction: column !important;
      }

      .topbar-inner{
        padding-inline:0 !important;
      }

      .content-wrap{
        padding-inline:12px;
      }

      .sidebar{
        display:none;
      }

      .main-panel{
        padding:20px 16px 18px;
      }

      .panel-header{
        padding:14px 12px 12px;
      }

      /* RESPONSIVIDADE DA TABELA: Transforma em lista vertical */
      .table-responsive {
        /* Remove o overflow-x para permitir a visualização da lista */
        overflow-x: visible;
        border: none;
        padding: 0;
      }

      .table {
        /* Remove o estilo padrão de tabela */
        border-collapse: collapse;
        width: 100%;
      }

      .table thead {
        /* Esconde o cabeçalho padrão */
        display: none;
      }

      .table tbody tr {
        /* Estilo de cada linha (agora um item de lista) */
        display: block;
        margin-bottom: 15px;
        border: 1px solid rgba(209, 213, 219, 0.8);
        border-radius: 12px;
        background: #fff;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      }

      .table tbody td {
        /* Estilo de cada célula */
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        border: none;
        border-bottom: 1px solid #eee; /* Separador entre campos */
        font-size: 13px;
      }
      
      .table tbody td:last-child {
        /* Estilo da célula de Ações */
        display: flex;
        justify-content: flex-end;
        border-bottom: none;
        padding-top: 12px;
      }
      
      .table tbody td:before {
        /* Adiciona o label do cabeçalho como pseudo-elemento */
        content: attr(data-label);
        font-weight: 600;
        color: #6b7280;
        text-transform: capitalize;
        white-space: nowrap;
        margin-right: 10px;
        flex-shrink: 0;
      }
      
      /* Ajuste da primeira célula (Nome) para remover o label, se necessário */
      .table tbody tr td:first-child:before {
          content: '';
          display: none;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <img src="img/logo-angel.png" alt="AngelFly Logo" onerror="this.style.display='none'"/>
          <div>
            <div class="brand-title">AngelFly Admin</div>
            <div style="font-size:12px; color:#6b7280;">User management panel</div>
          </div>
        </div>

        <div class="topbar-right">
          <div class="topbar-user-pill">
            <i class="bi bi-person"></i>
            <span id="topUserName">Loading...</span>
          </div>
          <a class="logout-link" onclick="handleLogout()">Log out</a>
        </div>
      </div>
    </header>

    <div class="content-wrap">
      <div class="content-inner">
        <aside class="sidebar">
          <div class="sidebar-card">
            <div class="sidebar-title">Admin</div>

            <div class="sidebar-item active" onclick="navigateDashboard()">
              <div class="left">
                <i class="bi bi-person-lines-fill"></i>
                <span>Manage Users</span>
              </div>
              <span style="font-size:10px; text-transform:uppercase; letter-spacing:0.08em;">Now</span>
            </div>

            <div class="sidebar-item" onclick="navigateCreateUser()">
              <div class="left">
                <i class="bi bi-person-plus"></i>
                <span>Create User</span>
              </div>
              <i class="bi bi-chevron-right"></i>
            </div>
          </div>
        </aside>

        <div class="main-panel-wrapper">
          <main class="main-panel">
            <div class="panel-header">
              <div class="panel-header-main">
                <div class="panel-title-badge">
                  <i class="bi bi-shield-lock"></i> Admin only
                </div>
                <div class="panel-title">Manage users</div>
              </div>
              <div class="muted">
                List and manage all users. You can edit their information or permanently delete their accounts.
              </div>
              <a class="btn-generate" onclick="navigateCreateUser()">
                <i class="bi bi-plus-lg"></i> New user
              </a>
            </div>

            <div id="feedback" class="alert mt-3" style="display:none;"></div>

            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Match ID</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="userTableBody">
                  <tr><td colspan="6" class="text-center text-muted">Loading users...</td></tr>
                </tbody>
              </table>
            </div>

            <div id="pagination" class="d-flex justify-content-end mt-3 gap-2">
                </div>

          </main>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="editUserForm">
          <input type="hidden" id="edit_id" name="id">
          <div class="modal-body">
            
            <div class="mb-3">
              <label for="edit_email" class="form-label">Email *</label>
              <input type="email" class="form-control" id="edit_email" name="email" required>
            </div>
            
            <div class="mb-3">
              <label for="edit_password" class="form-label">Password (New, optional)</label>
              <input type="password" class="form-control" id="edit_password" name="password" placeholder="Leave blank to keep current password">
            </div>

            <div class="mb-3">
              <label for="edit_full_name" class="form-label">Full name *</label>
              <input type="text" class="form-control" id="edit_full_name" name="full_name" required>
            </div>

            <div class="mb-3">
              <label for="edit_user_role" class="form-label">Role *</label>
              <select id="edit_user_role" class="form-select" name="user_role" required>
                <option value="restaurant">Restaurant</option>
                <option value="driver">Driver</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="edit_match_id" class="form-label">Match ID</label>
              <input type="text" class="form-control" id="edit_match_id" name="match_id">
              <div class="form-text">ID used to match with Notion or other systems.</div>
            </div>

            <div id="editWeekConfigWrapper">
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label for="edit_week_start_day" class="form-label">Week start</label>
                        <select id="edit_week_start_day" class="form-select" name="week_start_day">
                            <option value="">Default</option>
                            <option value="0">Sunday</option>
                            <option value="1">Monday</option>
                            <option value="2">Tuesday</option>
                            <option value="3">Wednesday</option>
                            <option value="4">Thursday</option>
                            <option value="5">Friday</option>
                            <option value="6">Saturday</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label for="edit_week_end_day" class="form-label">Week end</label>
                        <select id="edit_week_end_day" class="form-select" name="week_end_day">
                            <option value="">Default</option>
                            <option value="0">Sunday</option>
                            <option value="1">Monday</option>
                            <option value="2">Tuesday</option>
                            <option value="3">Wednesday</option>
                            <option value="4">Thursday</option>
                            <option value="5">Friday</option>
                            <option value="6">Saturday</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="edit_is_active" name="is_active">
              <label class="form-check-label" for="edit_is_active">User is active</label>
            </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn-generate" id="btnEditSubmit">
                <span id="btnEditSubmitText">Save Changes</span>
                <span id="btnEditSubmitSpinner" class="spinner-border spinner-border-sm" role="status" style="display:none;"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteUserModalLabel">Confirm Deletion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to permanently delete the user: <strong><span id="deleteUserName"></span></strong>?</p>
          <p class="text-danger small">This action is irreversible and will remove the user's authentication and profile records.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="btnConfirmDelete">
            <i class="bi bi-trash"></i> Delete
          </button>
        </div>
      </div>
    </div>
  </div>


  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
  ></script>
  <script>
    const USERS_API_URL = "/api/admin/users";
    let currentPage = 1;
    let totalPages = 1;
    let currentDeleteUserId = null;
    let editModalInstance;

    function safeGet(obj, path, fallback=null){
      try{
        return path.split(".").reduce((o, k)=>o?.[k], obj) ?? fallback;
      }catch(e){ return fallback; }
    }

    document.addEventListener("DOMContentLoaded", () => {
      initPage();
    });

    async function initPage(){
      await loadUserContext();
      // Inicializa o modal de edição
      const editModalElement = document.getElementById('editUserModal');
      editModalInstance = new bootstrap.Modal(editModalElement);
      
      // Carrega a lista inicial de usuários
      await loadUsers(currentPage);

      setupEditForm();
      setupDeleteConfirmation();
    }

    // --- Utility Functions ---

    /**
     * Trunca uma string para um número máximo de caracteres e adiciona "..."
     * @param {string} s A string a ser truncada.
     * @param {number} max O número máximo de caracteres visíveis.
     * @returns {string} A string truncada ou original.
     */
    function truncateText(s, max = 11){
      if(s == null || s === "") return "N/A";
      const str = String(s);
      return str.length > max ? str.slice(0, max) + "..." : str;
    }

    async function loadUserContext(){
      try{
        const res = await fetch("/api/user/context", { credentials:"include" });
        if(!res.ok) throw new Error("context fetch failed");
        const ctx = await res.json();
        const displayName =
          safeGet(ctx, "restaurant.restaurant_name") ||
          safeGet(ctx, "user.name") ||
          safeGet(ctx, "user.email") ||
          "User";

        document.getElementById("topUserName").textContent = displayName;
      }catch(e){
        document.getElementById("topUserName").textContent = "Failed to load user";
      }
    }

    function showFeedback(type, message){
      const fb = document.getElementById("feedback");
      fb.style.display = message ? "block" : "none";
      fb.className = "alert mt-3 alert-" + (type === "error" ? "danger" : "success");
      fb.textContent = message || "";
      if(message) setTimeout(() => fb.style.display = "none", 5000);
    }

    // --- Navigation ---

    function navigateDashboard(){
        window.location.href = "/admin"; // Já está na dashboard, apenas recarrega
    }

    function navigateCreateUser(){
      window.location.href = "/admin/create-user";
    }

    async function handleLogout(){
      try{
        await fetch("/api/logout", { method:"POST", credentials:"include" });
        window.location.href = "/login-restaurant.html";
      }catch(e){
        window.location.href = "/login-restaurant.html";
      }
    }

    // --- User Listing (Read) ---

    function renderUserRow(user){
      const isActive = user.is_active;
      
      // 1. Variáveis de Status
      const statusClass = isActive ? 'status-active' : 'status-inactive';
      const statusText = isActive ? 'Active' : 'Inactive';
      
      // 2. Variável de Match ID (Truncado)
      const fullMatchId = user.match_id || 'N/A';
      const matchIdDisplay = truncateText(fullMatchId, 11);
      
      // 3. Variável de Email (Truncado)
      const fullEmail = user.email || 'N/A';
      const emailDisplay = truncateText(fullEmail, 11);
      
      // 4. Labels para responsividade
      const nameLabel = 'Name';
      const emailLabel = 'Email';
      const roleLabel = 'Role';
      const matchIdLabel = 'Match ID';
      const statusLabel = 'Status';
      const actionsLabel = 'Actions';


      return `
        <tr>
          <td data-label="${nameLabel}">${user.full_name || emailDisplay}</td>
          <td data-label="${emailLabel}" title="${fullEmail}">${emailDisplay}</td>  
          <td data-label="${roleLabel}">
            <span class="badge-role role-${user.user_role}">${user.user_role}</span>
          </td>
          <td data-label="${matchIdLabel}" title="${fullMatchId}">${matchIdDisplay}</td>
          <td data-label="${statusLabel}">
            <span class="fw-bold ${statusClass}">${statusText}</span>
          </td>
          <td data-label="${actionsLabel}">
            <button class="btn btn-sm btn-outline-primary btn-action" onclick="openEditModal('${user.id}')">
                <i class="bi bi-pencil-square"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger btn-action" onclick="openDeleteModal('${user.id}', '${user.full_name || user.email}')">
                <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `;
    }

    function renderPagination(total, limit, page){
        const totalPages = Math.ceil(total / limit);
        const paginationHtml = [];

        if(totalPages <= 1) {
            document.getElementById("pagination").innerHTML = '';
            return;
        }

        const prevDisabled = page === 1 ? 'disabled' : '';
        const nextDisabled = page === totalPages ? 'disabled' : '';

        paginationHtml.push(`
            <button class="btn btn-sm btn-outline-secondary" ${prevDisabled} onclick="loadUsers(${page - 1})">
                <i class="bi bi-arrow-left"></i> Previous
            </button>
        `);
        
        // Exibir página atual e total
        paginationHtml.push(`
            <span class="btn btn-sm btn-outline-secondary disabled">Page ${page} of ${totalPages}</span>
        `);

        paginationHtml.push(`
            <button class="btn btn-sm btn-outline-secondary" ${nextDisabled} onclick="loadUsers(${page + 1})">
                Next <i class="bi bi-arrow-right"></i>
            </button>
        `);

        document.getElementById("pagination").innerHTML = paginationHtml.join('');
    }

    async function loadUsers(page = 1, limit = 50){
      const tableBody = document.getElementById("userTableBody");
      tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted"><div class="spinner-border spinner-border-sm me-2"></div> Loading users...</td></tr>';
      showFeedback("success", "");
      
      try{
        const res = await fetch(`${USERS_API_URL}?page=${page}&limit=${limit}`, { credentials:"include" });
        if(!res.ok) throw new Error("Failed to load users");
        
        const data = await res.json();
        
        currentPage = data.page;
        totalPages = Math.ceil(data.total / data.limit);

        if(data.items && data.items.length > 0){
          const html = data.items.map(renderUserRow).join('');
          tableBody.innerHTML = html;
        } else {
          tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No users found.</td></tr>';
        }

        renderPagination(data.total, data.limit, data.page);

      }catch(e){
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading users.</td></tr>';
        showFeedback("error", "Error loading users: " + (e.message || "Communication error"));
        document.getElementById("pagination").innerHTML = '';
      }
    }


    // --- User Editing (Update) ---

    // Função auxiliar para controlar o display da configuração da semana no modal
    function toggleEditWeekFields(role){
        const wrapper = document.getElementById("editWeekConfigWrapper");
        wrapper.style.display = role === "restaurant" ? "block" : "none";
    }

    async function openEditModal(userId){
        showFeedback("success", ""); // Limpa feedback
        try {
            // **Usa a rota direta de GET por ID**
            const res = await fetch(`${USERS_API_URL}/${userId}`, { credentials: "include" });
            
            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData?.error || "Failed to load user data.");
            }
            
            const user = await res.json(); 

            if (!user || !user.id) {
                showFeedback("error", "User data received is empty or invalid.");
                return;
            }

            // 1. Popula os campos do modal
            document.getElementById("edit_id").value = user.id;
            document.getElementById("edit_email").value = user.email || '[Email not found]'; 
            document.getElementById("edit_full_name").value = user.full_name || '';
            document.getElementById("edit_user_role").value = user.user_role || 'restaurant';
            document.getElementById("edit_match_id").value = user.match_id || '';
            document.getElementById("edit_password").value = ''; // Sempre limpa o campo de senha
            document.getElementById("edit_is_active").checked = user.is_active;
            
            // Popula os campos da semana, tratando null
            document.getElementById("edit_week_start_day").value = user.week_start_day !== null ? String(user.week_start_day) : '';
            document.getElementById("edit_week_end_day").value = user.week_end_day !== null ? String(user.week_end_day) : '';

            // 2. Controla a visibilidade da configuração da semana
            toggleEditWeekFields(user.user_role);

            // 3. Adiciona listener de mudança de role
            document.getElementById("edit_user_role").onchange = (e) => toggleEditWeekFields(e.target.value);

            // 4. Abre o modal
            editModalInstance.show();

        } catch (e) {
            // Isso irá exibir a mensagem de erro da API ou a de comunicação
            showFeedback("error", "Error loading user data: " + (e.message || "Communication error"));
            document.querySelector(".panel-header").insertAdjacentHTML('afterend', 
              `<div class="alert alert-danger mt-3">DEBUG ERROR: ${e.message}</div>`);
        }
    }

    function setEditLoading(isLoading){
      const btn = document.getElementById("btnEditSubmit");
      const text = document.getElementById("btnEditSubmitText");
      const spinner = document.getElementById("btnEditSubmitSpinner");

      if(isLoading){
        btn.disabled = true;
        text.textContent = "Saving...";
        spinner.style.display = "inline-block";
      } else {
        btn.disabled = false;
        text.textContent = "Save Changes";
        spinner.style.display = "none";
      }
    }

    function setupEditForm(){
        const form = document.getElementById("editUserForm");
        form.addEventListener("submit", handleEditUser);
    }

    async function handleEditUser(event){
        event.preventDefault();
        setEditLoading(true);

        const userId = document.getElementById("edit_id").value;
        const email = document.getElementById("edit_email").value.trim();
        const password = document.getElementById("edit_password").value.trim();
        const user_role = document.getElementById("edit_user_role").value;
        const full_name = document.getElementById("edit_full_name").value.trim();
        const match_id = document.getElementById("edit_match_id").value.trim();
        const is_active = document.getElementById("edit_is_active").checked;
        const week_start_day_raw = document.getElementById("edit_week_start_day").value;
        const week_end_day_raw = document.getElementById("edit_week_end_day").value;

        // Sanitização dos campos de semana
        let week_start_day = null;
        let week_end_day = null;
        if (user_role === "restaurant") {
            // Se o valor for vazio, envia null. Caso contrário, Number(valor)
            week_start_day = week_start_day_raw !== "" ? Number(week_start_day_raw) : null;
            week_end_day = week_end_day_raw !== "" ? Number(week_end_day_raw) : null;
        } else {
             // Se não é restaurante, forçamos o envio de null (para limpar se houver)
             week_start_day = null;
             week_end_day = null;
        }


        const payload = {
            email,
            user_role,
            full_name,
            match_id: match_id || null,
            is_active,
            week_start_day,
            week_end_day
        };

        if (password.length >= 6) {
            payload.password = password;
        }

        try{
            const res = await fetch(`${USERS_API_URL}/${userId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify(payload)
            });

            const data = await res.json();

            if(!res.ok){
                throw new Error(data?.error || "Failed to update user.");
            }
            
            editModalInstance.hide();
            showFeedback("success", "User successfully updated!");
            await loadUsers(currentPage); // Recarrega a lista para mostrar as mudanças

        }catch(e){
            showFeedback("error", "Update failed: " + (e.message || "Unknown error"));
        }finally{
            setEditLoading(false);
        }
    }

    // --- User Deletion (Delete) ---

    function openDeleteModal(userId, userName){
        currentDeleteUserId = userId;
        document.getElementById("deleteUserName").textContent = userName;
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteUserModal'));
        deleteModal.show();
    }

    function setupDeleteConfirmation(){
        document.getElementById("btnConfirmDelete").addEventListener("click", handleDeleteUser);
    }

    async function handleDeleteUser(){
        const userId = currentDeleteUserId;
        if (!userId) return;

        // Fecha o modal de confirmação primeiro
        const deleteModalElement = document.getElementById('deleteUserModal');
        const deleteModalInstance = bootstrap.Modal.getInstance(deleteModalElement);
        if(deleteModalInstance) deleteModalInstance.hide();

        showFeedback("success", ""); // Limpa feedback anterior
        
        try{
            const res = await fetch(`${USERS_API_URL}/${userId}`, {
                method: "DELETE",
                credentials: "include"
            });

            const data = await res.json();

            if(!res.ok){
                throw new Error(data?.error || "Failed to delete user.");
            }
            
            showFeedback("success", `User ID ${userId} successfully deleted.`);
            await loadUsers(currentPage); // Recarrega a lista

        }catch(e){
            showFeedback("error", "Deletion failed: " + (e.message || "Unknown error"));
        }finally{
            currentDeleteUserId = null;
        }
    }
  </script>
</body>
</html>