<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AngelFly - Dashboard</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
    <link rel="icon" type="image/x-icon" href="img/logo-angel (1) (1).ico" />

  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
  />
  <style>
@import url('https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Urbanist:ital,wght@0,100..900;1,100..900&display=swap');
  </style>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Montserrat' !important; }

    :root{
      --bg:#f3f1f0; --panel:#fff; --muted:#f0efef;
      --text:#111827; --primary:#ff7a18; --primary-dark:#ea580c;
      --sidebar-item:#fff; --sidebar-active:#e9e9e9;
      --radius-xl:14px; --radius-lg:10px;
    }

    body { background:radial-gradient(circle at top left, #ffe4c4 0, #f3f1f0 45%, #ffffff 100%); color:var(--text); }
    .app-shell{ min-height:100vh; display:flex; flex-direction:column; }

    .topbar{
      background:var(--panel); border-bottom:1px solid #e5e7eb;
      padding:20px 22px; display:flex; align-items:center; justify-content:space-between;
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .brand img{ height:7rem; object-fit:contain; }

    .topbar-right{ display:flex; align-items:center; gap:18px; font-size:14px; font-weight:500; }
    .topbar-user{ display:flex; align-items:center; gap:8px; }
    .logout-link{ cursor:pointer; color:var(--text); text-decoration:none; }
    .logout-link:hover{ text-decoration:underline; }

    .content-wrap{
      flex:1; width:100% !important; display:flex; justify-content:center;
      grid-template-columns:220px 1fr; gap:18px; padding:22px;
    }

    .sidebar{ background:transparent; padding-top:8px; width:30%; }
    .sidebar-card{ background:transparent; display:flex; flex-direction:column; gap:10px; }
    .sidebar-item{
      background:var(--sidebar-item); border-radius:8px; padding:12px 14px; font-size:14px;
      display:flex; align-items:center; justify-content:space-between; cursor:pointer; border:1px solid #eee;
    }
    .sidebar-item.active{ background:var(--sidebar-active); font-weight:600; }
    .sidebar-sub{ margin-left:10px; display:none; flex-direction:column; gap:8px; }
    .sidebar-sub .sidebar-item{ padding:10px 12px; font-size:13px; }
    .sidebar-item .left{ display:flex; align-items:center; gap:10px; }

    .debug-box{ display:none !important; }

    .main-panel{
      background:var(--panel); border-radius:var(--radius-xl);
      padding:25px 18px; width:100%; box-shadow:0 1px 0 rgba(0,0,0,0.03);
      display:flex; flex-direction:column; height:fit-content; gap:14px;
    }
    .panel-header{
      background:var(--muted); border-radius:10px; padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; font-size:15px; font-weight:600;
      gap:10px; flex-wrap:wrap;
    }
    .panel-header .muted{ font-weight:500; color:var(--text); }

    .table-card{
      background:var(--panel); border:1px solid #eee; border-radius:var(--radius-lg);
      padding:12px; position:relative;
    }
    .table-head{
      display:grid; grid-template-columns:120px 140px 1fr 140px;
      gap:1rem;
      font-size:13px; font-weight:700; padding:10px 12px;
    }
    .table-body{ max-height:340px; overflow-y:scroll; padding:6px 4px; }

    .row-item{
      display:grid;
      grid-template-columns:120px 140px 1fr 140px;
      align-items:center;
      padding:16px 12px;
      margin:6px 6px;
      border-radius:8px;
      background:#f0efef;
      font-size:14px;
      gap:1rem;
    }
    .row-item:nth-child(even){ background:#fff; }

    .row-item .value{
      text-align:right;
      font-weight:700;
    }

    .row-label{
      display:none;
      font-weight:600;
      margin-right:6px;
      opacity:0.7;
    }
    .row-value{
      display:inline-block;
    }

    .order-code{
      font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      background:#fff;
      border:1px solid #e5e7eb;
      cursor:help;
      max-width:100%;
      white-space:nowrap;
    }

    .panel-footer{
      display:flex; justify-content:flex-end; align-items:center; gap:12px; padding-top:10px;
      flex-wrap:wrap;
    }
    .week-select{
      background:var(--panel); border:1px solid #e5e7eb; border-radius:8px;
      padding:10px 12px; font-size:14px; min-width:200px;
    }

    .btn-generate{
      background:var(--primary); border:none; color:#fff; border-radius:8px; font-weight:700;
      padding:10px 18px; font-size:14px;
    }
    .btn-generate:hover{ background:var(--primary-dark); }

    /* loading overlay */
    .panel-loading{
      position:absolute; inset:0; background:rgba(255,255,255,0.7);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:10px; border-radius:var(--radius-lg); z-index:10;
    }
    .shimmer{
      width:96%; height:18px; border-radius:8px;
      background:linear-gradient(90deg,#eee 25%,#f7f7f7 50%,#eee 75%);
      background-size:200% 100%; animation:shimmer 1.1s infinite;
    }
    @keyframes shimmer{ 0%{background-position:200% 0} 100%{background-position:-200% 0} }

    .debug-box{
      margin-top:8px; background:#0b1020; color:#e5e7eb; font-size:12px;
      padding:10px; border-radius:8px; white-space:pre-wrap; display:none;
      max-height:160px; overflow:auto;
    }

    @media (max-width:900px){
      .content-wrap{ grid-template-columns:1fr; }
      .sidebar{ order:2; }
      .panel-header{ flex-direction:column; align-items:flex-start; gap:6px; }
      .table-head,
      .row-item{
        grid-template-columns:1fr 1fr;
      }
    }

    @media(max-width:768px){
      .table-card{ overflow:visible !important; }
      .table-body{ overflow-y:scroll !important; }

      .table-head{ display:none; }

      .row-item{
        grid-template-columns:1fr;
        align-items:flex-start;
        padding:12px 10px;
        font-size:13px;
        box-shadow:0 1px 3px rgba(0,0,0,0.05);
      }
      .row-item > div{
        display:flex;
        justify-content:space-between;
        width:100%;
      }
      .row-label{ display:inline-block; }
      .row-item .value{ text-align:right; }

      .customer{ display:flex !important; }

      .sidebar{ display:none !important; }
      .topbar .container{
        flex-direction:column !important;
        gap:10px !important;
      }
    }
  </style>
</head>

<body>
  <div class="app-shell">

    <header class="topbar">
      <div class="container d-flex justify-content-between align-items-center">
        <div class="brand">
          <img src="img/logo-angel.png" alt="AngelFly Logo" onerror="this.style.display='none'"/>
        </div>

        <div class="topbar-right">
          <div class="topbar-user">
            <i class="bi bi-person"></i>
            <span id="topUserName">Carregando...</span>
          </div>
          <a class="logout-link" onclick="handleLogout()">Log out</a>
        </div>
      </div>
    </header>

    <div class="content-wrap container">

      <aside class="sidebar">
        <div class="sidebar-card">
          <div class="sidebar-item active" onclick="setSection('dashboard')">
            <div class="left"><span>Dashboard</span></div>
            <i class="bi bi-grid"></i>
          </div>

          <div class="sidebar-item d-none" onclick="toggleReports()">
            <div class=" left"><span>Reports</span></div>
            <i id="reportsChevron" class="bi bi-chevron-down"></i>
          </div>
          <div id="reportsSub" class="sidebar-sub">
            <div class="sidebar-item" onclick="setSection('reports-month')">
              <div class="left"><i class="bi bi-calendar3"></i><span>Monthly</span></div>
            </div>
            <div class="sidebar-item" onclick="setSection('reports-driver')">
              <div class="left"><i class="bi bi-truck"></i><span>Drivers</span></div>
            </div>
          </div>

          <div class="sidebar-item d-none" onclick="setSection('historic')">
            <div class="left "><span>Historic</span></div>
          </div>
        </div>
      </aside>

      <div class="d-flex flex-column align-items-end" style="width:100%;">
        <main class="main-panel">

          <div class="panel-header">
            <div>
              Restaurant: <span id="restaurantName" class="muted">Loading...</span>
            </div>
            <div>
              Total Value of <span id="weekLabel">--</span>:
              <span id="weekTotal">$0.00</span>
            </div>
          </div>

          <section class="table-card" id="tableCard">
            <div class="table-head">
              <div>Order ID</div>
              <div>Day</div>
              <div class="customer">Customer</div>
              <div style="text-align:right;">Value to Pay</div>
            </div>

            <div id="tableBody" class="table-body"></div>

            <div id="panelLoading" class="panel-loading" style="display:none;">
              <div class="spinner-border text-warning" role="status"></div>
              <div class="shimmer"></div>
              <div class="shimmer"></div>
              <div class="shimmer"></div>
              <small class="text-muted">Loading orders...</small>
            </div>
          </section>

          <div id="debugBox" class="debug-box"></div>

        </main>

        <div class="panel-footer">
          <select id="weekSelect" class="week-select" onchange="changeWeek()"></select>

          <button class="btn-generate" onclick="exportCSV()">
            Generate CSV
          </button>

          <button class="btn btn-outline-secondary" onclick="exportPDF()">
            Generate PDF
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    let USER_NAME = "Restaurant";
    // -----------------------------
    // CONFIG
    // -----------------------------
    const REPORT_API_URL = "/api/report/month";
    const DEBUG = true; // coloca false depois que estiver tudo ok

    let CURRENT_RESTAURANT_MATCH_ID = null;
    let CURRENT_ROLE = null;
    let CURRENT_WEEK_START_DAY = 1; // 0=domingo, 1=segunda, etc. default segunda
    let CURRENT_ROWS = [];
    let CURRENT_WEEK_LABEL = "";

    // -----------------------------
    // DEBUG helpers
    // -----------------------------
    function logDebug(...args){
      console.log("üüß [DASH]", ...args);
      if(!DEBUG) return;
      const box = document.getElementById("debugBox");
      box.style.display = "block";
      box.textContent += args.map(a => {
        try { return typeof a === "string" ? a : JSON.stringify(a, null, 2); }
        catch(e){ return String(a); }
      }).join(" ") + "\n";
      box.scrollTop = box.scrollHeight;
    }

    // -----------------------------
    // HELPERS
    // -----------------------------
    function formatISODate(dateObj){
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth()+1).padStart(2,"0");
      const d = String(dateObj.getDate()).padStart(2,"0");
      return `${y}-${m}-${d}`;
    }

    function formatDateBRShort(iso){
      if(!iso) return "--";
      const [y,m,d] = iso.split("-");
      return `${d}/${m}`;
    }

    function showPanelLoading(show){
      document.getElementById("panelLoading").style.display = show ? "flex" : "none";
    }

    function safeGet(obj, path, fallback=null){
      try{
        return path.split(".").reduce((o, k)=>o?.[k], obj) ?? fallback;
      }catch(e){ return fallback; }
    }

    // pega n√∫mero robusto do Notion
    function getNotionNumber(props, key){
      const p = props?.[key];
      if(!p) return null;

      if(p.type === "formula") return p.formula?.number ?? null;
      if(p.type === "number") return p.number ?? null;

      if(p.type === "rollup"){
        const arr = p.rollup?.array;
        if(Array.isArray(arr) && arr[0]){
          const first = arr[0];
          if(first.type === "number") return first.number ?? null;
          if(first.type === "formula") return first.formula?.number ?? null;
          if(first.type === "unique_id") return first.unique_id?.number ?? null;
        }
      }
      return null;
    }

    function coerceNumber(v){
      if(v == null) return 0;
      if(typeof v === "number" && Number.isFinite(v)) return v;

      if(typeof v === "string"){
        const cleaned = v.replace(/\./g, "").replace(",", ".").replace(/[^\d.-]/g, "");
        const n = Number(cleaned);
        return Number.isFinite(n) ? n : 0;
      }

      return 0;
    }

    // -----------------------------
    // NORMALIZA√á√ÉO DO NOTION
    // -----------------------------
    function normalizeNotionOrder(order){
      const props = order.properties || {};

      const code =
        safeGet(props, 'Order Number: .title.0.plain_text') ||
        safeGet(props, 'Order Number: .title.0.text.content') ||
        order.id || "--";

      const customer =
        safeGet(props, 'Customer Name.rollup.array.0.title.0.plain_text') ||
        safeGet(props, 'Customer Name.rollup.array.0.title.0.text.content') ||
        safeGet(props, 'üë• Custumer Name: .rich_text.0.plain_text') ||
        "--";

      const createdISO =
        safeGet(props, 'Order Placement DateTime.created_time') ||
        safeGet(props, 'Created time.created_time') ||
        order.created_time;

      const day = createdISO
        ? new Date(createdISO).toLocaleDateString("en-US", {
            month:"short", day:"numeric", year:"numeric"
          })
        : "--";

      let valueRaw =
        getNotionNumber(props, "Angel Fly Total ") ??
        getNotionNumber(props, "Angel Fly Total");

      const value = coerceNumber(valueRaw);
      const created_ts = createdISO ? new Date(createdISO).getTime() : 0;

      return { code, day, customer, value, createdISO, created_ts };
    }

    // -----------------------------
    // INIT
    // -----------------------------
    document.addEventListener("DOMContentLoaded", () => {
      initDashboard();
    });

    async function initDashboard(){
      await loadUserContext();
      buildWeekSelect();
      // render after resize toggle possibility
      window.addEventListener('resize', () => renderTableRows(CURRENT_ROWS, CURRENT_WEEK_LABEL));
      await generateReportForSelectedWeek(true);
    }

    async function loadUserContext(){
      try{
        logDebug("Fetching /api/user/context...");
        const res = await fetch("/api/user/context", { credentials:"include" });
        logDebug("Context status:", res.status);

        if(!res.ok) throw new Error("context fetch failed");
        const ctx = await res.json();
        logDebug("Context response:", ctx);

        CURRENT_ROLE = ctx?.user?.role || null;
        CURRENT_RESTAURANT_MATCH_ID = ctx?.restaurant?.restaurant_match_id || null;

        const weekStartDayRaw = ctx?.restaurant?.week_start_day;
        if (Number.isInteger(weekStartDayRaw) && weekStartDayRaw >= 0 && weekStartDayRaw <= 6) {
          CURRENT_WEEK_START_DAY = weekStartDayRaw;
        }

        const displayName =
          ctx?.restaurant?.restaurant_name ||
          ctx?.user?.name ||
          ctx?.user?.email ||
          "Usu√°rio";

        document.getElementById("topUserName").textContent = displayName;
        document.getElementById("restaurantName").textContent = displayName;
        
        // CAPTURA O NOME DE USU√ÅRIO PARA USO NO EXPORT
        USER_NAME = ctx?.restaurant?.restaurant_name || "Restaurant"; 

        logDebug("Role:", CURRENT_ROLE);
        logDebug("restaurant_match_id:", CURRENT_RESTAURANT_MATCH_ID);
        logDebug("week_start_day:", CURRENT_WEEK_START_DAY);

      }catch(e){
        console.error(e);
        logDebug("Context error:", e.message || e);
        document.getElementById("topUserName").textContent = "Erro ao carregar usu√°rio";
        document.getElementById("restaurantName").textContent = "Erro";
      }
    }

    // -----------------------------
    // WEEK SELECT
    // -----------------------------
    function buildWeekSelect(){
      const select = document.getElementById("weekSelect");
      select.innerHTML = "";

      const today = new Date();
      today.setHours(0,0,0,0);

      const currentDow = today.getDay(); // 0=domingo..
      let diff = currentDow - CURRENT_WEEK_START_DAY;
      if (diff < 0) diff += 7;

      // √¢ncora = in√≠cio da semana atual segundo configura√ß√£o do restaurante
      const anchor = new Date(today);
      anchor.setDate(today.getDate() - diff);

      const NUM_WEEKS = 12; // √∫ltimas 12 semanas

      for (let i = 0; i < NUM_WEEKS; i++) {
        const start = new Date(anchor);
        start.setDate(anchor.getDate() - i * 7);

        const end = new Date(start);
        end.setDate(start.getDate() + 6);

        const weekStartISO = formatISODate(start);
        const weekEndISO = formatISODate(end);
        const label = `${formatDateBRShort(weekStartISO)} to ${formatDateBRShort(weekEndISO)}`;

        const opt = document.createElement("option");
        opt.value = `${weekStartISO}|${weekEndISO}`;
        if (i === 0) opt.selected = true;
        opt.textContent = label;
        select.appendChild(opt);
      }

      logDebug("WeekSelect built. First value:", select.value);
    }

    function changeWeek(){
      generateReportForSelectedWeek(false);
    }

    // -----------------------------
    // FORMAT ORDER CODE (6 chars + ...)
    // -----------------------------
    function formatOrderCode(code){
      if (!code) return "--";
      const s = String(code);
      if (s.length <= 6) return s;
      return s.slice(0, 6) + "...";
    }

    // escape helper
    function escapeHtml(s){
      return String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
    }

    // truncate helper (default 10 chars)
    function truncateText(s, max = 10){
      if(s == null || s === "") return "--";
      const str = String(s);
      return str.length > max ? str.slice(0, max) + "..." : str;
    }

    // returns true if viewport is mobile (matches CSS breakpoint)
    function isMobileViewport(){
      return window.matchMedia && window.matchMedia('(max-width:768px)').matches;
    }

    // -----------------------------
    // RENDER (truncates customer > 10 chars only on mobile)
    // -----------------------------
    function renderTableRows(rows, weekLabel){
      const body = document.getElementById("tableBody");

      if(rows.length === 0){
        body.innerHTML = `
          <div class="p-3 text-muted" style="font-size:14px;">
            No order found for this week.
          </div>
        `;
      } else {
        const mobile = isMobileViewport();

        body.innerHTML = rows.map(r => {
          const fullCustomer = r.customer || "--";
          const displayCustomer = mobile ? truncateText(fullCustomer, 10) : fullCustomer;

          return `
          <div class="row-item">
            <div>
              <span class="row-label">Order:</span>
              <span
                class="row-value order-code"
                title="${escapeHtml(String(r.code || ""))}"
              >
                ${escapeHtml(formatOrderCode(r.code))}
              </span>
            </div>
            <div>
              <span class="row-label">Day:</span>
              <span class="row-value">${escapeHtml(r.day)}</span>
            </div>
            <div class="customer">
              <span class="row-label">Customer:</span>
              <span class="row-value" title="${escapeHtml(fullCustomer)}">
                ${escapeHtml(displayCustomer)}
              </span>
            </div>
            <div class="value">
              <span class="row-label">Value:</span>
              <span class="row-value">$${Number(r.value||0).toFixed(2)}</span>
            </div>
          </div>
          `;
        }).join("");
      }

      const total = (rows || []).reduce((acc, r)=>acc + (Number(r.value)||0), 0);
      document.getElementById("weekTotal").textContent = `$${total.toFixed(2)}`;
      document.getElementById("weekLabel").textContent = weekLabel || "--";
    }

    // -----------------------------
    // FETCH RELAT√ìRIO (SEMANA)
    // -----------------------------
    async function generateReportForSelectedWeek(isAuto=false){
      const select = document.getElementById("weekSelect");
      if(!select || !select.value){
        logDebug("Nenhuma semana selecionada ainda.");
        return;
      }

      const [weekStart, weekEnd] = select.value.split("|");
      const weekLabel = select.options[select.selectedIndex].textContent;
      const month = weekStart.slice(0, 7); // "YYYY-MM"

      logDebug("generateReportForSelectedWeek ->", { weekStart, weekEnd, month, isAuto });

      showPanelLoading(true);

      try{
        const res = await fetch(REPORT_API_URL, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          credentials:"include",
          body: JSON.stringify({
            month,
            week_start: weekStart,
            week_end: weekEnd,
          }),
        });

        logDebug("Report status:", res.status);

        const text = await res.text();
        logDebug("Raw response text:", text.slice(0, 1000));

        let data;
        try { data = JSON.parse(text); }
        catch(e){
          throw new Error("Resposta n√£o √© JSON v√°lido.");
        }

        // üî• NOVO FORMATO: 1 item com orders[]
if (!Array.isArray(data) || !data.length || !Array.isArray(data[0].orders)) {
  logDebug("Formato inesperado do relat√≥rio:", data);
  CURRENT_ROWS = [];
  renderTableRows([], weekLabel);
  return;
}

const orders = data[0].orders;
logDebug("Orders returned:", orders.length);

// agora SIM cada item √© um pedido
const norm = orders.map(o => ({
  code: o.order_number || "--",
  day: o.day || "--",
  customer: o.customer_name || "--",
  value: Number(o.value || 0),
  createdISO: o.last_edited_time,
  created_ts: o.last_edited_time ? new Date(o.last_edited_time).getTime() : 0,
}));

        // s√≥ por seguran√ßa, filtramos de novo pelo intervalo da semana
      
        // ordena mais recente -> mais antigo
        norm.sort((a, b) => (b.created_ts || 0) - (a.created_ts || 0));

CURRENT_ROWS = norm;
CURRENT_WEEK_LABEL = weekLabel;

renderTableRows(norm, weekLabel);

      }catch(e){
        console.error(e);
        logDebug("‚ùå Weekly report error:", e.message || e);
        CURRENT_ROWS = [];
        CURRENT_WEEK_LABEL = "";
        renderTableRows([], weekLabel);
        if(!isAuto) alert("Erro ao carregar pedidos da semana.");
      }finally{
        showPanelLoading(false);
      }
    }

    // -----------------------------
    // EXPORT CSV (IDs COMPLETOS)
    // -----------------------------
    function csvEscape(val){
      const s = String(val ?? "");
      if(/[",\n;]/.test(s)){
        return `"${s.replace(/"/g, '""')}"`;
      }
      return s;
    }

    function exportCSV(){
        const rows = CURRENT_ROWS || [];
        if(!rows.length){
            alert("N√£o tem pedidos para exportar nessa semana.");
            return;
        }
        const header = ["Order Code", "Day", "Customer", "Value"];
        const lines = [
            header.join(","),
            ...rows.map(r => ([
                csvEscape(r.code), // ID completo
                csvEscape(r.day),
                csvEscape(r.customer),
                csvEscape(Number(r.value).toFixed(2)),
            ]).join(","))
        ];

        const csvContent = "\uFEFF" + lines.join("\n");
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        
        // Gera√ß√£o do nome do arquivo com Nome do Usu√°rio + Data/Per√≠odo
        const fileSafeLabel = (CURRENT_WEEK_LABEL || "week")
            .replace(/\s+/g, "_")
            .replace(/[^ \w\-]/g, "");

        const fileSafeName = (USER_NAME || "restaurant")
            .replace(/\s+/g, "_")
            .replace(/[^ \w\-]/g, "");

        const a = document.createElement("a");
        a.href = url;
        a.download = `angelFly_${fileSafeName}_${fileSafeLabel}.csv`; // Nome do arquivo atualizado
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        logDebug("CSV exported:", a.download, "rows:", rows.length);
    }

    // -----------------------------
    // EXPORT PDF (IDs COMPLETOS, SEM SOBREPOR)
    // -----------------------------
    function exportPDF() {
        const rows = CURRENT_ROWS || [];
        if (!rows.length) {
            alert("N√£o tem pedidos para exportar nessa semana.");
            return;
        }
        if (!window.jspdf || !window.jspdf.jsPDF) {
            alert("Erro ao carregar o gerador de PDF.");
            return;
        }

        // Usando A4 (padr√£o)
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y = 20;
        const pageHeight = doc.internal.pageSize.height;
        const total = (rows || []).reduce((acc, r) => acc + (Number(r.value) || 0), 0).toFixed(2);
        const date = new Date().toLocaleDateString("pt-BR", { year: 'numeric', month: '2-digit', day: '2-digit' });

        // T√≠tulo do PDF
        doc.setFontSize(16);
        doc.text(`AngelFly - Restaurant Report`, 14, y);
        y += 8;

        // Infos do Restaurante e Per√≠odo
        doc.setFontSize(12);
        const restaurantName = document.getElementById("restaurantName").textContent;
        doc.text(`Restaurant: ${restaurantName}`, 14, y);
        doc.text(`Period: ${CURRENT_WEEK_LABEL}`, 14, y + 6);
        doc.text(`Generated on: ${date}`, 14, y + 12);
        doc.text(`Total: $${total}`, 190, y + 12, { align: "right" });
        y += 24;

        // Cabe√ßalho da tabela
        const fontSize = 10;
        const lineHeight = 5;
        const rowHeight = 6;
        doc.setFontSize(fontSize);
        doc.text("Order", 14, y);
        doc.text("Day", 60, y);
        doc.text("Customer", 90, y);
        doc.text("Value", 190, y, { align: "right" });
        y += 4;
        doc.line(14, y, 196, y);
        y += 6;

        // Desenha as linhas da tabela
        rows.forEach(r => {
            const orderCode = String(r.code || "--");
            const codeLines = doc.splitTextToSize(orderCode, 45); // 45mm de largura
            const maxLines = codeLines.length;

            // Verifica se precisa de nova p√°gina antes de desenhar
            if (y + rowHeight > pageHeight - 20) {
                doc.addPage();
                y = 20;
                // Cabe√ßalho em nova p√°gina
                doc.setFontSize(fontSize);
                doc.text("Order", 14, y);
                doc.text("Day", 60, y);
                doc.text("Customer", 90, y);
                doc.text("Value", 190, y, { align: "right" });
                y += 4;
                doc.line(14, y, 196, y);
                y += 6;
            }

            // Desenha as linhas
            for (let i = 0; i < maxLines; i++) {
                const lineY = y + i * lineHeight;
                if (codeLines[i]) doc.text(codeLines[i], 14, lineY);
            }

            doc.text(r.day || "--", 60, y);
            doc.text(r.customer || "--", 90, y);
            doc.text(`$${Number(r.value || 0).toFixed(2)}`, 190, y, { align: "right" });

            y += maxLines * lineHeight + 2; // Espa√ßamento entre linhas
            doc.line(14, y, 196, y); // Linha divis√≥ria
            y += 4;
        });

        // Total no final
        doc.setFontSize(11);
        doc.text(`Total: $${total}`, 190, y, { align: "right" });

        // Gera√ß√£o do nome do arquivo com Nome do Usu√°rio + Data/Per√≠odo
        const fileSafeLabel = (CURRENT_WEEK_LABEL || "week")
            .replace(/\s+/g, "_")
            .replace(/[^ \w\-]/g, "");
        
        const fileSafeName = (USER_NAME || "restaurant")
            .replace(/\s+/g, "_")
            .replace(/[^ \w\-]/g, "");

        // Salva o PDF com o novo nome
        doc.save(`angelFly_${fileSafeName}_${fileSafeLabel}.pdf`);
    }
    // -----------------------------
    // SIDEBAR
    // -----------------------------
    function toggleReports(){
      const sub = document.getElementById("reportsSub");
      const chev = document.getElementById("reportsChevron");
      const open = sub.style.display === "flex";
      sub.style.display = open ? "none" : "flex";
      chev.className = open ? "bi bi-chevron-down" : "bi bi-chevron-up";
    }

    function setSection(section){
      document.querySelectorAll(".sidebar-item").forEach(el => el.classList.remove("active"));
      const items = document.querySelectorAll(".sidebar-card > .sidebar-item");
      if(section === "dashboard") items[0].classList.add("active");
      if(section.startsWith("reports")) items[1].classList.add("active");
      if(section === "historic") items[2].classList.add("active");
    }

    // -----------------------------
    // LOGOUT
    // -----------------------------
    async function handleLogout(){
      try{
        await fetch("/api/logout", { method:"POST", credentials:"include" });
        window.location.href = "/login-restaurant.html";
      }catch(e){
        window.location.href = "/login-restaurant.html";
      }
    }
  </script>
</body>
</html>