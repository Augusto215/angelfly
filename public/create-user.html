  <!DOCTYPE html>
  <html lang="en-US">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>AngelFly - Create User</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
        <link rel="icon" type="image/x-icon" href="img/logo-angel (1) (1).ico" />

    
    <style>
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Urbanist:ital,wght@0,100..900;1,100..900&display=swap');
    </style>

    <style>
      /* * O CSS abaixo é copiado do admin.html para garantir a consistência
      * visual completa do painel.
      */
      * {
        margin:0;
        padding:0;
        box-sizing:border-box;
        font-family:'Montserrat', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
      }

      :root{
        --bg:#f3f1f0;
        --bg-gradient: radial-gradient(circle at top left, #ffe4c4 0, #f3f1f0 45%, #ffffff 100%);
        --panel:#fff;
        --muted:#f6f6f6;
        --text:#111827;
        --primary:#ff7a18;
        --primary-dark:#ea580c;
        --primary-soft:rgba(255,122,24,0.12);
        --sidebar-item:#fff;
        --sidebar-active:#111827;
        --sidebar-active-text:#ffffff;
        --radius-xl:18px;
        --radius-lg:12px;
        --shadow-soft:0 18px 45px rgba(15,23,42,0.12);
      }

      body {
        background:var(--bg-gradient);
        color:var(--text);
      }

      .app-shell{
        min-height:100vh;
        display:flex;
        flex-direction:column;
      }

      .topbar{
        background:transparent;
        padding:18px 22px 8px;
        display:flex;
        align-items:center;
        justify-content:space-between;
      }

      .topbar-inner{
        background:rgba(255,255,255,0.92);
        backdrop-filter: blur(14px);
        border-radius:999px;
        padding:10px 18px;
        border:1px solid rgba(148,163,184,0.25);
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:16px;
        width:100%;
        max-width:1180px;
        margin:0 auto;
        box-shadow:0 10px 30px rgba(15,23,42,0.08);
      }

      .brand{
        display:flex;
        align-items:center;
        gap:12px;
      }

      .brand img{
        height:3.5rem;
        object-fit:contain;
      }

      .brand-title{
        font-size:14px;
        font-weight:600;
        letter-spacing:0.03em;
        text-transform:uppercase;
        color:#6b7280;
      }

      .topbar-right{
        display:flex;
        align-items:center;
        gap:14px;
        font-size:14px;
        font-weight:500;
      }

      .topbar-user-pill{
        display:flex;
        align-items:center;
        gap:8px;
        padding:6px 12px;
        border-radius:999px;
        background:var(--muted);
        font-size:13px;
      }

      .topbar-user-pill i{
        font-size:16px;
      }

      .logout-link{
        cursor:pointer;
        color:var(--primary-dark);
        text-decoration:none;
        font-size:13px;
        font-weight:600;
        padding:6px 12px;
        border-radius:999px;
        border:1px solid rgba(249,115,22,0.3);
        background:rgba(249,115,22,0.06);
      }

      .logout-link:hover{
        background:rgba(249,115,22,0.12);
      }

      .content-wrap{
        flex:1;
        width:100% !important;
        display:flex;
        justify-content:center;
        padding:18px 16px 32px;
      }

      .content-inner{
        display:grid;
        grid-template-columns:260px minmax(0,1fr);
        gap:20px;
        width:100%;
        max-width:1180px;
        align-items:flex-start;
      }

      /* SIDEBAR */
      .sidebar{
        background:transparent;
      }

      .sidebar-card{
        background:rgba(255,255,255,0.9);
        backdrop-filter: blur(18px);
        border-radius:var(--radius-xl);
        padding:14px 12px;
        border:1px solid rgba(148,163,184,0.25);
        box-shadow:0 12px 35px rgba(15,23,42,0.08);
        display:flex;
        flex-direction:column;
        gap:8px;
      }

      .sidebar-title{
        font-size:12px;
        text-transform:uppercase;
        letter-spacing:0.08em;
        font-weight:600;
        color:#9ca3af;
        padding:4px 10px 2px;
      }

      .sidebar-item{
        background:var(--sidebar-item);
        border-radius:999px;
        padding:9px 12px;
        font-size:13px;
        display:flex;
        align-items:center;
        justify-content:space-between;
        cursor:pointer;
        border:1px solid transparent;
        transition:all 0.16s ease-out;
      }

      .sidebar-item .left{
        display:flex;
        align-items:center;
        gap:9px;
      }

      .sidebar-item i{
        opacity:0.8;
        font-size:15px;
      }

      .sidebar-item:hover{
        border-color:rgba(148,163,184,0.5);
        background:rgba(255,255,255,0.95);
      }

      .sidebar-item.active{
        background:var(--sidebar-active);
        color:var(--sidebar-active-text);
        border-color:var(--sidebar-active);
        box-shadow:0 10px 26px rgba(15,23,42,0.35);
      }

      .sidebar-item.active i{
        opacity:1;
      }

      /* MAIN PANEL */
      .main-panel-wrapper{
        width:100%;
        display:flex;
        justify-content:flex-start;
      }

      .main-panel{
        background:var(--panel);
        border-radius:var(--radius-xl);
        padding:24px 22px 22px;
        width:100%;
        max-width:820px;
        box-shadow:var(--shadow-soft);
        border:1px solid rgba(148,163,184,0.16);
        display:flex;
        flex-direction:column;
        gap:16px;
      }

      .panel-header{
        border-radius:18px;
        padding:16px 16px 14px;
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        font-size:15px;
        font-weight:600;
        flex-wrap:wrap;
        gap:10px;
        background:
          radial-gradient(circle at top left, rgba(255,122,24,0.16), transparent 55%),
          var(--muted);
      }

      .panel-header-main{
        display:flex;
        flex-direction:column;
        gap:4px;
      }

      .panel-title-badge{
        display:inline-flex;
        align-items:center;
        gap:6px;
        padding:4px 9px;
        border-radius:999px;
        background:var(--primary-soft);
        color:var(--primary-dark);
        font-size:11px;
        text-transform:uppercase;
        letter-spacing:0.08em;
        font-weight:600;
      }

      .panel-title{
        font-size:18px;
        font-weight:700;
      }

      .panel-header .muted{
        font-weight:500;
        color:#4b5563;
        font-size:13px;
        max-width:380px;
      }

      .panel-meta-chip{
        padding:6px 10px;
        border-radius:999px;
        background:#fff;
        border:1px dashed rgba(148,163,184,0.6);
        font-size:12px;
        color:#6b7280;
        display:flex;
        align-items:center;
        gap:6px;
      }

      .panel-meta-dot{
        width:7px;
        height:7px;
        border-radius:999px;
        background:#22c55e;
      }

      /* FORM / TABLE */
      .form-section{
        border-radius:16px;
        padding:16px 14px 8px;
        background:#ffffff;
      }

      .form-section-title{
        display:flex;
        align-items:center;
        justify-content:space-between;
        margin-bottom:12px;
        gap:8px;
      }

      .form-section-title span{
        font-size:13px;
        font-weight:600;
        color:#4b5563;
      }

      .form-section-sub{
        font-size:12px;
        color:#9ca3af;
      }

      .form-label{
        font-size:13px;
        font-weight:500;
        color:#374151;
        margin-bottom:4px;
      }

      .form-control,
      .form-select{
        border-radius:999px;
        border:1px solid rgba(148,163,184,0.75);
        font-size:13px;
        padding:9px 12px;
        min-height:40px;
        background:#f9fafb;
        transition:all 0.14s ease-out;
      }

      .form-control:focus,
      .form-select:focus{
        border-color:var(--primary);
        box-shadow:0 0 0 1px rgba(249,115,22,0.28);
        background:#ffffff;
      }

      .form-text{
        font-size:11px;
        color:#9ca3af;
      }

      .role-pill-group{
        display:flex;
        gap:6px;
        flex-wrap:wrap;
      }

      .role-pill-group select{
        max-width:210px;
      }

      .checkbox-chip{
        display:flex;
        align-items:center;
        gap:6px;
        padding:7px 10px;
        border-radius:999px;
        background:#f9fafb;
        border:1px solid rgba(209,213,219,0.9);
        font-size:12px;
        color:#4b5563;
        margin-top:8px;
      }

      .checkbox-chip .form-check-input{
        margin-top:0;
      }

      .btn-generate,
      .btn-primary{
        background:var(--primary);
        border:none;
        color:#fff;
        border-radius:999px;
        font-weight:700;
        padding:9px 18px;
        font-size:14px;
        display:inline-flex;
        align-items:center;
        gap:6px;
      }

      .btn-generate:hover,
      .btn-primary:hover{
        background:var(--primary-dark);
      }

      .btn-outline-secondary{
        border-radius:999px;
        font-size:13px;
        padding-inline:16px;
      }

      .alert{
        border-radius:14px;
        font-size:13px;
        padding:9px 12px;
      }

      /* RESPONSIVIDADE GERAL */
      @media (max-width:992px){
        .content-inner{
          grid-template-columns:1fr;
        }
        .sidebar{
          order:2;
        }
        .main-panel-wrapper{
          order:1;
          justify-content:center;
        }
        .main-panel{
          max-width:100%;
        }
      }

      @media(max-width:768px){
        .topbar{
          padding: 0 !important; 
          border-radius: 0 !important;
          padding-inline:0 !important;
        }
        .topbar-inner
        {        border-radius: 0 !important;

          flex-direction: column !important;
        }

        .topbar-inner{
          padding-inline:0 !important;
        }

        .content-wrap{
          padding-inline:12px;
        }

        .sidebar{
          display:none;
        }

        .main-panel{
          padding:20px 16px 18px;
        }

        .panel-header{
          padding:14px 12px 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <header class="topbar">
        <div class="topbar-inner">
          <div class="brand">
            <img src="img/logo-angel.png" alt="AngelFly Logo" onerror="this.style.display='none'"/>
            <div>
              <div class="brand-title">AngelFly Admin</div>
              <div style="font-size:12px; color:#6b7280;">User management panel</div>
            </div>
          </div>

          <div class="topbar-right">
            <div class="topbar-user-pill">
              <i class="bi bi-person"></i>
              <span id="topUserName">Loading...</span>
            </div>
            <a class="logout-link" onclick="handleLogout()">Log out</a>
          </div>
        </div>
      </header>

      <div class="content-wrap">
        <div class="content-inner">
          <aside class="sidebar">
            <div class="sidebar-card">
              <div class="sidebar-title">Admin</div>

              <div class="sidebar-item" onclick="navigateDashboard()">
                <div class="left">
                  <i class="bi bi-person-lines-fill"></i>
                  <span>Manage Users</span>
                </div>
                <i class="bi bi-chevron-right"></i>
              </div>

              <div class="sidebar-item active" onclick="navigateCreateUser()">
                <div class="left">
                  <i class="bi bi-person-plus"></i>
                  <span>Create User</span>
                </div>
                <span style="font-size:10px; text-transform:uppercase; letter-spacing:0.08em;">Now</span>
              </div>
            </div>
          </aside>

          <div class="main-panel-wrapper">
            <main class="main-panel">
              <div class="panel-header">
                <div class="panel-header-main">
                  <div class="panel-title-badge">
                    <i class="bi bi-shield-lock"></i> Admin only
                  </div>
                  <div class="panel-title">Create New User</div>
                </div>
                <div class="muted">
                  Fill out the required information to provision a new user account.
                </div>
                <a class="btn-generate" onclick="navigateDashboard()">
                  <i class="bi bi-arrow-left"></i> Back to list
                </a>
              </div>

              <div id="feedback" class="alert mt-3" style="display:none;"></div>

              <form id="createUserForm" class="form-section row g-3">
                  <div class="col-md-6">
                      <label for="email" class="form-label">Email *</label>
                      <input type="email" class="form-control" id="email" name="email" required>
                  </div>
                  <div class="col-md-6">
                      <label for="password" class="form-label">Password *</label>
                      <input type="password" class="form-control" id="password" name="password" required minlength="6">
                  </div>

                  <div class="col-12">
                      <label for="full_name" class="form-label">Full name *</label>
                      <input type="text" class="form-control" id="full_name" name="full_name" required>
                  </div>

                  <div class="col-md-6">
                      <label for="user_role" class="form-label">Role *</label>
                      <select id="user_role" class="form-select" name="user_role" required>
                          <option value="restaurant" selected>Restaurant</option>
                          <option value="driver">Driver</option>
                          <option value="admin">Admin</option>
                      </select>
                  </div>
                  
                  <div class="col-md-6" id="matchIdWrapper">
                      <label for="match_id" class="form-label">Match ID</label>
                      <select class="form-select" id="match_id" name="match_id">
                          <option value="">(Loading list...)</option>
                      </select>
                      <div class="form-text">ID to sync Notion to Panel</div>
                  </div>

                  <div class="col-12" id="weekConfigWrapper">
                      <div class="form-section-title">
                          <span>Restaurant Week Configuration (Optional)</span>
                      </div>
                      <div class="row g-3 mb-3">
                          <div class="col-md-6">
                              <label for="week_start_day" class="form-label">Week start day</label>
                              <select id="week_start_day" class="form-select" name="week_start_day">
                                  <option value="" selected>Default</option>
                                  <option value="0">Sunday</option>
                                  <option value="1">Monday</option>
                                  <option value="2">Tuesday</option>
                                  <option value="3">Wednesday</option>
                                  <option value="4">Thursday</option>
                                  <option value="5">Friday</option>
                                  <option value="6">Saturday</option>
                              </select>
                          </div>

                          <div class="col-md-6">
                              <label for="week_end_day" class="form-label">Week end day</label>
                              <select id="week_end_day" class="form-select" name="week_end_day">
                                  <option value="" selected>Default</option>
                                  <option value="0">Sunday</option>
                                  <option value="1">Monday</option>
                                  <option value="2">Tuesday</option>
                                  <option value="3">Wednesday</option>
                                  <option value="4">Thursday</option>
                                  <option value="5">Friday</option>
                                  <option value="6">Saturday</option>
                              </select>
                          </div>
                      </div>
                  </div>
                  
                  <div class="col-12 d-none">
                      <div class="form-check form-switch checkbox-chip">
                          <input class="form-check-input" type="checkbox" id="is_active" name="is_active" checked>
                          <label class="d-none form-check-label" for="is_active">User is active</label>
                      </div>
                  </div>

                  <div class="col-12 pt-3">
                      <button type="submit" class="btn-primary" id="btnSubmit">
                          <span id="btnSubmitText"><i class="bi bi-person-plus-fill"></i> Create Account</span>
                          <span id="btnSubmitSpinner" class="spinner-border spinner-border-sm" role="status" style="display:none;"></span>
                      </button>
                      <a onclick="navigateDashboard()" class="btn btn-outline-secondary ms-2">Cancel</a>
                  </div>
              </form>
            </main>
          </div>
        </div>
      </div>
    </div>


    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    ></script>
    <script>
      const USERS_API_URL = "/api/admin/users";
      
      // Elementos DOM
      const USER_ROLE_SELECT = document.getElementById("user_role");
      const MATCH_ID_SELECT = document.getElementById("match_id");
      const WEEK_CONFIG_WRAPPER = document.getElementById("weekConfigWrapper");
      const MATCH_ID_WRAPPER = document.getElementById("matchIdWrapper");


      document.addEventListener("DOMContentLoaded", () => {
        initPage();
      });

      function initPage(){
        loadUserContext();
        setupEventListeners();
        
        // Carrega a lista de Match IDs inicial (baseado na Role padrão: 'restaurant')
        toggleMatchIdAndWeekFields(USER_ROLE_SELECT.value);
      }

      // --- Utility Functions ---

      function safeGet(obj, path, fallback=null){
        try{
          return path.split(".").reduce((o, k)=>o?.[k], obj) ?? fallback;
        }catch(e){ return fallback; }
      }

      async function loadUserContext(){
        try{
          const res = await fetch("/api/user/context", { credentials:"include" });
          if(!res.ok) throw new Error("context fetch failed");
          const ctx = await res.json();
          const displayName =
            safeGet(ctx, "restaurant.restaurant_name") ||
            safeGet(ctx, "user.name") ||
            safeGet(ctx, "user.email") ||
            "User";

          document.getElementById("topUserName").textContent = displayName;
        }catch(e){
          document.getElementById("topUserName").textContent = "Failed to load user";
        }
      }

      function showFeedback(type, message){
        const fb = document.getElementById("feedback");
        fb.style.display = message ? "block" : "none";
        fb.className = "alert mt-3 alert-" + (type === "error" ? "danger" : "success");
        fb.textContent = message || "";
        if(message) setTimeout(() => fb.style.display = "none", 5000);
      }

      function setFormLoading(isLoading){
        const btn = document.getElementById("btnSubmit");
        const text = document.getElementById("btnSubmitText");
        const spinner = document.getElementById("btnSubmitSpinner");

        if(isLoading){
          btn.disabled = true;
          text.innerHTML = "Creating...";
          spinner.style.display = "inline-block";
        } else {
          btn.disabled = false;
          text.innerHTML = '<i class="bi bi-person-plus-fill"></i> Create Account';
          spinner.style.display = "none";
        }
      }


      // --- Navigation ---

      function navigateDashboard(){
          window.location.href = "/admin"; 
      }

      function navigateCreateUser(){
        window.location.href = "/create-user";
      }

      async function handleLogout(){
        try{
          await fetch("/api/logout", { method:"POST", credentials:"include" });
          window.location.href = "/login-restaurant.html";
        }catch(e){
          window.location.href = "/login-restaurant.html";
        }
      }


      // --- Dynamic Match ID Loading and Field Visibility ---
      
      /**
       * Busca os IDs e Nomes de Restaurantes ou Drivers e preenche o select Match ID.
       * @param {string} role A role do usuário ('driver' ou 'restaurant').
       */
      async function loadMatchIdOptionsForCreateForm(role) {
          MATCH_ID_SELECT.innerHTML = '<option value="">Carregando...</option>';
          MATCH_ID_SELECT.disabled = true;

          let apiUrl = '';
          role = role.toLowerCase();

          if (role === 'driver') {
              apiUrl = '/api/drivers';
          } else if (role === 'restaurant') {
              apiUrl = '/api/restaurants';
          } else {
              // Se a role não é relevante, limpa e desabilita
              MATCH_ID_SELECT.innerHTML = '<option value="">N/A (Somente para Driver/Restaurant)</option>';
              MATCH_ID_SELECT.disabled = true;
              return;
          }

          try {
              // Chamada à rota do server.js
              const response = await fetch(apiUrl);
              if (!response.ok) throw new Error("Failed to fetch list.");
              
              // O response.json() já é o array de { id, name }
              const data = await response.json(); 
              
              // Limpa e insere a opção padrão
              MATCH_ID_SELECT.innerHTML = '<option value="">Select an ID</option>';

              // Preenche o select com ID e Nome
              data.forEach(item => {
                  const option = document.createElement('option');
                  option.value = item.id; 
                  option.textContent = item.name;
                  MATCH_ID_SELECT.appendChild(option);
              });
              MATCH_ID_SELECT.disabled = false;

          } catch (error) {
              console.error('Erro ao carregar lista de Match IDs:', error);
              MATCH_ID_SELECT.innerHTML = '<option value="">Erro ao carregar lista</option>';
              MATCH_ID_SELECT.disabled = true;
          }
      }

      /**
       * Controla a visibilidade dos campos de Match ID e Configuração de Semana
       * e dispara o carregamento das listas.
       * @param {string} role A role do usuário.
       */
      /**
 * Controla a visibilidade dos campos de Match ID e Configuração de Semana
 * e dispara o carregamento das listas.
 * @param {string} role A role do usuário.
 */
function toggleMatchIdAndWeekFields(role) {
    role = role.toLowerCase();
    
    // 1. Configuração de Semana (Apenas para Restaurante)
    WEEK_CONFIG_WRAPPER.style.display = role === "restaurant" ? "block" : "none";
    
    // 2. Campo Match ID: Visível APENAS para 'restaurant' (AQUI ESTÁ A MUDANÇA)
    const isMatchIdRelevant = role === "restaurant"; 
    
    // Mostra o wrapper se a role for 'restaurant', senão esconde.
    MATCH_ID_WRAPPER.style.display = isMatchIdRelevant ? "block" : "none";
    
    if (isMatchIdRelevant) {
        // Se for 'restaurant', carrega a lista
        loadMatchIdOptionsForCreateForm(role);
    } else {
        // Limpa e desabilita o select quando não for 'restaurant', 
        // embora o campo esteja escondido, é bom para consistência.
        MATCH_ID_SELECT.innerHTML = '<option value="">N/A</option>';
        MATCH_ID_SELECT.disabled = true;
    }
}


      // --- Setup and Submission ---

      function setupEventListeners() {
          document.getElementById("createUserForm").addEventListener("submit", handleCreateUser);
          
          // Listener para mudança de Role
          USER_ROLE_SELECT.addEventListener('change', (event) => {
              toggleMatchIdAndWeekFields(event.target.value);
          });
      }

      async function handleCreateUser(event){
          event.preventDefault();
          setFormLoading(true);
          showFeedback("success", ""); // Limpa feedback

          const form = event.target;
          const email = form.email.value.trim();
          const password = form.password.value.trim();
          const user_role = form.user_role.value;
          const full_name = form.full_name.value.trim();
          // ** Agora pega o valor do select **
          const match_id = form.match_id.value.trim(); 
          const is_active = form.is_active.checked;
          const week_start_day_raw = form.week_start_day.value;
          const week_end_day_raw = form.week_end_day.value;


          if (!email || !password || !full_name) {
              showFeedback("error", "Please fill in all required fields (Email, Password, Full Name).");
              setFormLoading(false);
              return;
          }
          
          // Sanitização dos campos de semana
          let week_start_day = null;
          let week_end_day = null;
          if (user_role === "restaurant") {
              // Se o valor for vazio, envia null. Caso contrário, Number(valor)
              week_start_day = week_start_day_raw !== "" ? Number(week_start_day_raw) : null;
              week_end_day = week_end_day_raw !== "" ? Number(week_end_day_raw) : null;
          }


          const payload = {
              email,
              password,
              user_role,
              full_name,
              match_id: match_id || null, // Envia null se vazio
              is_active,
              week_start_day,
              week_end_day
          };

          try{
              const res = await fetch(USERS_API_URL, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  credentials: "include",
                  body: JSON.stringify(payload)
              });

              const data = await res.json();

              if(!res.ok){
                  // A API deve retornar um erro específico no corpo do JSON
                  throw new Error(data?.error || "Failed to create user.");
              }
              
              showFeedback("success", `User "${full_name}" created successfully!`);
              form.reset(); // Limpa o formulário após sucesso
              // Recarrega o Match ID (que foi resetado junto com o formulário)
              toggleMatchIdAndWeekFields(document.getElementById("user_role").value); 

          }catch(e){
              showFeedback("error", "Creation failed: " + (e.message || "Unknown error"));
          }finally{
              setFormLoading(false);
          }
      }

    </script>
  </body>
  </html>